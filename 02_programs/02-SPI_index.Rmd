---
title: 'Measuring the Statistical Performance of Countries: An Overview of Updates to the World Bank Statistical Capacity Index'
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  bookdown::gitbook: 
    fig_width: 9
    fig_height: 6
abstract: 'National statistical systems are facing significant challenges. These challenges arise from increasing demands for high quality and trustworthy data to guide decision making, coupled with the rapidly changing landscape of the data revolution. To emphasize the urgent need for transformation and to help create a mechanism for learning amongst national statistical systems, the World Bank has developed new Statistical Performance Indicators (SPI) to monitor the statistical performance of countries. The SPI framework focuses on five key dimensions of a country’s statistical performance: (i) data use, (ii) data services, (iii) data products, (iv) data sources, and (v) data infrastructure.  The SPI will replace the Statistical Capacity Index (SCI) that the World Bank has regularly published since 2004. This note discusses the motivation behind the new SPI methodology, outlines some of its major features, and describes a new index based on the indicators.'
bibliography: ./bibliography.bib
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6, fig.path = "plots/", dev = c("png"), dpi=500)


library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population (2))
wgt <- 1

end_date <- 2023

```


```{r themes}

#ggplot theme
theme_spi <- function () { 
    theme_minimal() %+replace%
    theme(
      plot.caption = element_text(hjust = 0),
      plot.title=element_blank(), #remove all titles from plots (sometimes we may need to bring title outside plot)
      text = element_text(family="Andes")
    )
}


```

# Acknowledgements

The work on the Statistical Performance Indicators (SPI) has benefited greatly from the advice, comments and input of many individuals outside the World Bank SPI Team. The work took place under the overall guidance of Haishan Fu, Director of the Development Data Group at the World Bank, who played a key role in helping shape the framework of statistical performance developed here. We are grateful to the SPI Technical Advisory Group consisting of former National Statistician of the Philippines and Director of the Philippine Statistics Authority Lisa Bersales, the Director General of the National Institute of Statistics of Rwanda Yusuf Murangwa, the Chief Statistician of Colombia Juan Oviedo, and the former Director General of Eurostat and Chief Statistician of the European Union Walter Radermacher, and chaired by former National Statistician of the UK, John Pullinger.  

Several World Bank colleagues provided valuable feedback to this project.  They include Claudia P Rodriguez Alas, Rabah Arezki, Joao Pedro Wagner De Azevedo, Benu Bidani, Carlos Rodriguez Castelan, Ximena Del Carpio, Olivier Dupriez, Uche Ekhator, Tony Henri Mathias Jany Fujs, Nada Hamadeh, Craig Hammer, Tim Herzog, Kristen Himelein, Johannes Hoogeveen, Asif Mohammed Islam, Dean Jolliffe, Talip Kilic, Christoph Lakner, Maria Ana Lugo, Daniel Gerszon Mahler, Johan A. Mistiaen, Rinku Murgai, Ambar Narayan, Minh Nguyen, Utz Johann Pape, Martin Rama, Pierella Paci, Carolina Sanchez-Paramo, Ana Florina Pirlea, Emi Suzuki, Emil Daniel Tesliuc, Satoshi Tozaki, Tara Vishwanath, Divyanshi Wadhwa, Matthew Welch, Phillip Wollburg, Salman Zaidi, and Hassan Zaman. Elysee Kiti and Tigist Shibru provided superb administration support. 

Additionally, we benefited from discussions with the following: Louis Marc Ducharme, Jimmy McHugh, Brett Humburg, Francis Cicero de Leon Bobadilla, and Aubriana Wolferts (IMF)); Pietro Gennari (FAO); Francesca Perucci and Yongyi Min (UN Statistics Division); Ramesha Saligrama Krishnamurthy and Rifat Hossain (WHO); Viveka Palm (Eurostat); Rafael Diez de Medina, Ritash Sarna, Marie-Claire Sodergren, and Lara Badre (ILO); Silvia Montoya and Adolfo Imhof (UNESCO Institute of Statistics); Paul Schreyer (OECD); Emily Poskett (ONS, UK); Phil Cockerill (FCDO, UK); Johannes Jutting, Francois Fonteneau, Julia Schmidt, Yu Tian, and Archita Misra (PARIS21); Shaida Badiee, Eric Swanson and Jamison Crowell (Open Data Watch); Claire Melamed (GPSDD); Misha Belkindas (ODW Consulting); Mike Hughes (Full Fact); Peter Rosendorff (New York University); James Hollyer (University of Minnesota); and James Vreeland (Princeton University).

We apologize for any omissions and express our sincere gratitude to everyone, whether or not they are named here, who graciously gave their time and expertise.  We are grateful to the United Kingdom Foreign, Commonwealth and Development Office (FCDO, formerly named the Department for International Development) for funding assistance through Knowledge for Change (KCP) grants, including one for the World Development Report 2021 “Data for Better Lives”.



# Motivation

National statistical systems are at the heart of the successful governance of nations. They provide an essential public service, helping governments make decisions about the economy, society and environment and enabling citizens to hold those governments to account. 

The 2030 agenda for sustainable development has created a framework of goals and targets of universal applicability, designed to ensure that no one is left behind. This agenda requires national statistical systems to work together with other stakeholders within and across nations and regions to measure progress in a consistent and relevant way. At the same time, the data revolution has resulted in previously unimaginable sources of data becoming available that can be mobilized in support of the 2030 agenda in an open, transparent, and ethical manner.

However, many nations are struggling to build the necessary financial, human and technological capability to meet these goals. Assessing and improving the capacity of national statistical systems has long been part of the global agenda for statistics. Capacity assessment tools have been developed by organizations including PARIS21, the Food and Agriculture Organization of the United Nations (FAO), the United Nations Economic Commission for Europe (UNECE), the United Nations Economic Commission for Africa (UNECA) and the US Census Bureau. 

Since 2004, the World Bank’s Statistical Capacity Index (SCI) has been part of this global toolkit. The SCI has been used by several national and international agencies to measure progress in statistical capacity building and related investments. To remain useful in the current and future data landscape, the SCI needs to be updated. The SCI incorporates only a limited number of indicators and does not assess use of data sources beyond traditional censuses and surveys. Neither does the SCI consider data dissemination and how data are used. Finally, the SCI places a large weight on statistical output and activities, while neglecting the infrastructure and resource components of statistical systems.

The COVID-19 pandemic has added extra motivation and impetus for understanding and improving the performance of national statistical systems. Without good statistics, countries are hamstrung in their response to the pandemic and in navigating towards a better future. The statistical performance indicators proposed in this paper are a response to that motivation. The indicators are intended to be applicable to all nations and to be forward looking and comprehensive. They are designed to be used by national governments and statistical offices as well as international agencies and donors. The aim is to help create a learning data ecosystem that can develop and adapt iteratively to the ever-changing requirements of government and citizens for better data to support better decisions.



# Overview of the SPI Framework

The new Statistical Performance Indicators (SPI) build on the Statistical Capacity Indicators The new Statistical Performance Indicators (SPI) build on the Statistical Capacity Index (SCI), which the World Bank regularly published between 2004 and 2020. The SPI framework covers several of the same attributes as the SCI, such as statistical methodology, data, and periodicity, but expands into new areas as well. The goals of introducing the SPI are: to offer a forward looking framework, to measure all statistical systems – from less mature to highly advanced, to cover the entire national statistical system -  not just the National Statistical Office (NSO), and to provide countries incentives to build modern statistical systems. To help build transparency and confidence in the work, as well as to improve understanding and encourage further experimentation, refinement, and improvement of the measures, the data and the code underlying the construction of the SPI are made open.^[The code and data are available on [github]{https://github.com/worldbank/SPI} licensed under the [Creative Commons Attribution 4.0 International License]{https://creativecommons.org/licenses/by/4.0/}, which allows users to freely share, copy, and redistribute any of the materials, as well as adapt, remix, transform, and build upon the material for any purpose, so long as appropriate credit is given the SPI team and the other teams described under the license.]

*Figure 2.1: Virtuous Data Cycle*
![](SPI_cycle.png)

By helping countries identify the strengths and weaknesses of their national statistical system, the SPI can be a guide to decisions about priorities for investment and can help identify partner countries from which they might learn. This in turn can help both donor and recipient countries ensure that development assistance is targeted on areas of most national benefit. The SPI follows an approach that considers the system as a whole, which incorporates users, producers and partners at various levels. The indicators are designed to be dynamic and forward looking.  Improvements in performance can be represented as a virtuous data cycle that can become self-sustaining.
In this model, adapted from work done by the Organization for Economic Cooperation and Development, PARIS21 and Open Data Watch, investment in data leads to higher levels of effectiveness which drives innovation, value added and impact. 

The impact sought from national statistical systems is better decisions and stronger accountability. The way in which national statistical systems contribute to better decisions and stronger accountability is by meeting user needs for statistics. Such user needs are in turn met by the design and production of statistics and statistical indicators. The process of design and production relies on a wide range of organizations, working in partnership with the national statistical office as part of the national statistical system to develop and utilize richer data sources. To be successful the whole data ecosystem needs to build its capability to adapt and thrive.

Statistics have no value unless they are used. Consequently, the first pillar of the SPI is data use. A successful statistical system is one that produces data products that are highly used.
To meet user needs, the statistical system must develop a range of services that connect data users and producers and facilitate dialogue between them. The second pillar of the SPI is therefore data services that are trusted by users. A successful statistical system is one with highly valued and well used statistical services.

The dialogue between users and suppliers in turn drives the design and quality of statistical products that are created to meet the country requirement. These products should incorporate accuracy, timeliness, frequency, comparability, and levels of disaggregation. The third pillar of the SPI is therefore data products. A successful statistical system is one that generates high quality statistical indicators that can also track progress toward the Sustainable Development Goals (SDGs).

In order to create the required products, the statistical system needs to make use of a variety of sources from both within and outside the government. This will include making use of traditional data collection methods like censuses and surveys, and also administrative data, geospatial data, and data generated from the private sector and from citizens. It follows that the fourth pillar of the SPI is data sources. A successful statistical system is one which draws on all types of data sources relevant to the indicators that are to be produced. 

To complete the virtuous data cycle, the capability of the statistical system needs to be reviewed continuously to ensure that it is strong enough to deliver the data products and services and to promote data use. The fifth pillar of the SPI is therefore data infrastructure. A successful statistical system is one that develops both hard infrastructure (legislation, governance, standards) and soft infrastructure (skills, partnerships) and has the financial resources to deliver.




```{r data, include=FALSE}

#add in population
pop_df <- wbstats::wb_data(country="all",
             indicator='SP.POP.TOTL',
             start_date=2004,
             end_date=end_date) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=SP.POP.TOTL) %>%
  select(country, date, population) 


#read in the SPI dataset
spi_df_final_raw <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) 


spi_df_final <- spi_df_final_raw %>%
  filter(date>=end_date) %>%
  bind_rows(read_csv( file = paste(raw_dir, 'previous_vintages/SPI_data_2022.csv', sep="/")) %>% filter(date>=2021)) %>%
  bind_rows(read_csv( file = paste(raw_dir, 'previous_vintages/SPI_data_2020.csv', sep="/")) %>% filter(date==2020) %>% filter(iso3c %in% unique(spi_df_final_raw$iso3c))) %>%
  bind_rows(read_csv( file = paste(raw_dir, 'previous_vintages/SPI_data_2019.csv', sep="/")) %>% filter(date<2020) %>% filter(iso3c %in% unique(spi_df_final_raw$iso3c))) %>%           
  mutate(income=if_else(is.na(income), income_level, income)) %>%
  left_join(pop_df) %>%
  group_by(iso3c) %>%
  arrange(desc(date)) %>%
  fill(population, .direction = "downup") %>%
  mutate(wgt=wgt,
         weights=if_else(wgt==2,population,1))  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.



metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

metadata_full <- read_csv(paste(raw_dir, '/metadata/SPI_index_sources.csv', sep="")) %>%
  rename(source_name=descript) %>%
  bind_rows(metadata)
                             

pillars <- read_csv(paste(raw_dir, '/metadata/SPI_pillars.csv', sep=""))

```



```{r programs, include=FALSE}


#For mapping the result
# quality = "high"
# maps <- wbgmaps::wbgmaps[[quality]]
#load world bank map data
load(paste0(raw_dir, '/misc/maps.Rdata'))
standard_crop_wintri <- function() {
  l <- list(
    left=-12000000, right=16396891,
    top=9400000, bottom=-6500000
  )
  l$xlim <- c(l$left, l$right)
  l$ylim <- c(l$bottom, l$top)
  l
}


country_metadata <- wbstats::wb_countries()




spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.3,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)
}

spi_region_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  
    
    
    
    
  #add histogram by region 
  region_SPI_df <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    arrange(-`SPI Score`) 
  
  region_order <- c("Sub-Saharan Africa" ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )

  region_SPI_df <- region_SPI_df %>%
    mutate(region=factor(region, levels=region_order))
  
   p2 <-  ggplot(region_SPI_df, aes(x=`SPI Score`, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label), hjust=-0.5) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_fill_brewer(palette = 'Dark2') +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= 'Based on data for 2020 or the latest year available'
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  

  print(p2)
  


    
}

spi_income_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
      filter(date==max(date, na.rm=T)) %>%
      filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
      group_by( country) %>%
      #summarise(across(!! indicator,last)) %>%
      rename(data_available=!! indicator) %>%
      select(iso3c, date, data_available, weights) %>%
      right_join(country_metadata) %>%
      mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  %>%
      select(-starts_with('income')) %>%
      left_join(country_metadata)
    
    
    
    
    


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= 'Based on data for 2020 or the latest year available'
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income_level) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income_level, fill=income_level)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_fill_brewer(palette = 'Paired') +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
    


  print(p3)


}

spi_time_charts  <- function(data, indicator, title) {
  

    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by(income, date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ungroup() %>%
    ggplot(aes(y=`SPI Score`, x=date, color=income)) +
      geom_point() +
      geom_line() +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.'
      ) +
      expand_limits(y=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
  

            
      


  print(p4)
    
}

spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    filter(region!="Aggregates") %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  

  region_order <- c("Sub-Saharan Africa" ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )
  
  p2_alt <- SPI_map %>%
    ungroup() %>%
    mutate(region=factor(region, levels=region_order)) %>%
    ggplot(aes(x=data_available, y=region, color=spi_groups)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      xlab('Score') +
      expand_limits(x=c(0,100)) +
      scale_color_manual(
        name='SPI Score',
        values=col_pal,
        na.value='grey'
      ) +
      theme_spi() +
      theme(legend.position = 'top') 
   
p2_alt

}


spi_maturity_table <- function(data, indicators, reference_year) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      select(country, iso3c, date, income, region, all_of(indicators), SPI.INDEX) 
    
    
    spi_groups_quantiles <- quantile(df_overall$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
    
    df_overall <- df_overall %>%
      mutate(spi_groups=case_when(
        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_groups=factor(spi_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(spi_groups) %>%
      filter(!is.na(spi_groups)) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(spi_groups='Global') %>%
      group_by(spi_groups) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-spi_groups)))
    colnames(sumstats_df) = sumstats_df_long$spi_groups 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" ))

      sumstats_df
 

}


spi_group_table <- function(data, indicators, reference_year, group) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      left_join(country_metadata) %>%
      select(country, iso3c, date, income, region, lending_type, all_of(indicators), SPI.INDEX) %>%
      rename(group=!! group)
    
    
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(group) %>%
      filter(!is.na(group)) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(group='Global') %>%
      group_by(group) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-group)))
    colnames(sumstats_df) = sumstats_df_long$group 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, everything()) %>%
      select(-Series)

      sumstats_df
 

}

lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending_type, color=lending_type)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            title= element_text(size = 20),
            axis.title.y=element_blank(),
            text = element_text(size = 14)) 
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending_type) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending_type, fill=lending_type)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_fill_brewer(palette = 'Set1') +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            # title= element_text(size = 20),
            # axis.title.y=element_blank(),
            # text = element_text(size = 14)) 
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY22 Fragile and conflict-affected situations (https://thedocs.worldbank.org/en/doc/9b8fbdb62f7183cef819729cc9073671-0090082022/original/FCSList-FY06toFY22.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Somalia', 'Syrian Arab Republic','Yemen, Rep.', "Armenia", "Azerbaijan" )
  
  medium_intensity_conflict <- c('Burkina Faso','Burundi', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.','Ethiopia','Haiti',
                                 'Iraq', 'Libya','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan')
  
  high_institutional_social_fragility <- c('Congo, Rep.','Eritrea','Guinea-Bissau',
                                           'Kosovo','Lebanon','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = str_wrap('Source: World Bank. Statistical Performance Indicators. Non-FCS countries include all countries not classified as FCS.  This includes high income countries.',70),
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_fill_brewer(palette = 'Set2') +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
  
  
  
p2_alt2 
  
 
}


#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% 
    add_footer_lines(values = "Source: World Bank. Statistical Performance Indicators."                 ) %>%
    autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(data) {
  eq <- lm_robust(SPI.INDEX ~ value, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}

```

# Pillars and Dimensions of the SPI

The pillars of the SPI establish the essential interconnecting elements of a national statistical system. Each one must be healthy for the system as a whole to generate high levels of value. The pillars correspond to the components of an efficient organizational scorecard: outcomes (benefits for users) are delivered through outputs (services) which are generated by effective internal processes (design and delivery of products). These require the right inputs (data sources) and capabilities (infrastructure).

Each of the five pillars has specific attributes which we call dimensions. These dimensions offer distinct components of the pillars by which to judge a country’s statistical performance. The framework offers 5 pillars and 22 associated dimensions.  The framework of the SPI is shown in Figure 3.1 below.


*Figure 3.1: The Pillars and Dimensions that Construct the New SPI*
![](SPI_dashboard.png)
  
The dimensions break down each pillar into the core components or attributes of the system. It is likely that the balance between these dimensions will vary across countries and overtime but all are important, and a mature statistical system will score well against each of them. By setting them out in this way, it is possible for countries to ask questions about whether they have the balance right, given their domestic circumstances, when they compare themselves to other countries. The results provide a tool to explore what future investment is needed and where suitable comparators might be found.

## Pillar 1: Data use

The data use (outcome) pillar is segmented by five types of users: (i) the legislature, (ii) the executive branch, (iii) civil society (including sub-national actors), (iv) academia and (v) international bodies.  Each dimension would have associated indicators to measure performance. A mature system would score well across all dimensions whereas a less mature one would have weaker scores along certain dimensions. The gaps would give insights into prioritization among user groups and help answer questions as to why the existing services are not resulting in higher use of national statistics in a particular segment.

##	Pillar 2: Data services

The data services (output) pillar  is segmented by four service types: (i) the quality of data releases, (ii) the richness and openness of online access, (iii) the effectiveness of advisory and analytical services related to statistics, and (iv) the availability and use of data access services such as secure microdata access. Advisory and analytical services might incorporate elements related to data stewardship services including input to national data strategies, advice on data ethics and calling out misuse of data in accordance with the Fundamental Principles of Official Statistics.

##	Pillar 3: Data products

The data products (internal process) pillar is segmented by four topics and organized into (i) social, (ii) economic, (iii) environmental, and (iv) institutional dimensions using the typology of the Sustainable Development Goals (SDGs). This approach anchors the national statistical system’s performance around the essential data required to support the achievement of the 2030 global goals, and enables comparisons across countries so that a global view can be generated while enabling country specific emphasis to reflect the user needs of that country.


## Pillar 4: Data sources

The data sources (input) pillar is segmented by four types of sources generated by (i) the statistical office (censuses and surveys), and sources accessed from elsewhere such as (ii)  administrative data, (iii) geospatial data, and (iv) private sector data and citizen generated data. The appropriate balance between these source types will vary depending on a country’s institutional setting and the maturity of its statistical system. High scores should reflect the extent to which the sources being utilized enable the necessary statistical indicators to be generated. For example, a low score on environment statistics (in the data production pillar) may reflect a lack of use of (and low score for) geospatial data (in the data sources pillar). This type of linkage is inherent in the data cycle approach and can help highlight areas for investment required if country needs are to be met.

## Pillar 5: Data infrastructure

The data infrastructure (capability) pillar includes hard and soft infrastructure segments, itemizing essential cross cutting requirements for an effective statistical system. The segments are: (i) legislation and governance covering the existence of laws and a functioning institutional framework for the statistical system; (ii) standards and methods addressing compliance with recognized frameworks and concepts; (iii) skills including level of skills within the statistical system and among users (statistical literacy); (iv) partnerships reflecting the need for the statistical system to be inclusive and coherent; and (v) finance mobilized both domestically and from donors.

## A Dashboard

A score for each indicator, dimension, and pillar, and an overall score derived by aggregating the indicators (over these dimensions or over time), would:

  1.	facilitate an understanding of the maturity of the national statistical system (in relation to others, e.g., quintile groups of countries).
  
  2.	highlight relative strengths and weaknesses of the system and give an indication of the extent to which the official statistics can be relied upon.
  
  3.	point to which other countries a particular country could learn from as it seeks to improve and create incentives to develop in a forward looking way.
  
  4.	allow assessments of progress and provide a starting point for assessments of return on investments for funding on capacity building.
  
  5.	encourage continuous improvement. As countries improve, the bar for performance would also get higher.

Putting the scores together creates a dashboard for each national statistical system and the ability to generate a variety of tools to enable comparison and analysis.


  

```{r metadatatab1, eval=FALSE, include=FALSE}
####
# create table
####

pillars <- pillars %>%
  mutate(pillar=paste(pillar_number, pillar_name, sep=": ")) %>%
  select(pillar, spi_indicator_description)


pillars_tab <- flextable(pillars) %>%
  add_header_lines('SPI Pillars Metadata.') %>%
  set_header_labels(values=list(
                       pillar="Pillar",
                       spi_indicator_description="Brief Description"
                                   )) 

FitFlextableToPage(pillars_tab) %>%
  width(width=3.2) %>%
  align( align = "left", part = "body")


```

# Statistical Performance Indicators

##  SPI Dimensions and Indicators

Each dimension of the five pillars incorporates several indicators. These Statistical Performance Indicators embody the granular measures of performance. They can be aggregated to levels of dimensions and pillars, and finally to an overall performance score to get a higher level or a more general perspective of a country’s performance.

The indicators are designed to act as proxy measures of performance for each dimension. While not comprehensive, they should add value in assessing country performance along that dimension. The intention is for the pillars and dimensions to be the focus rather than the specific indicators. 
The indicators for the SPI are selected following these principles: (i) use of publicly accessible data; (ii) transparent methodology; (iii) easy replicability; (iv) a time series to track performance; (v) clear portrayal of outcomes and their supporting elements; (vi) being reflective of the SDGs; (vii) enable at-a-glance comparisons on a global scale.

Benefitting from large scale data collection efforts by organizations such as the World Bank, IMF, Open Data Watch, PARIS21, the ILO, WHO, UNESCO, IHSN, and the UN, among others, 51 indicators covering 14 out of the 22 dimensions for the dashboard have been compiled. These 51 indicators provide data for each of the five pillars on data use, data services, data products, data sources, and data infrastructure. Yet, there remain major gaps in several pillars because indicators to assess performance still need to be developed, and in some cases, indicators have limited data coverage.  This data availability challenge impedes efforts to measure the performance of statistical systems in certain areas and going forward countries and their international partners must work together to fill these gaps. 

Below is a brief description of the indicators (or lack thereof) we have available for the 22 dimensions in the SPI framework. A detailed description of the indicators is also available in the annex. For as many as eight dimensions there was no indicator with a developed methodology, or the data collection for that measure was incomplete. 

  * **Dimension 1.1: Data use by national legislature:** Not included because of lack of established methodology. In principle it may be possible to utilize websites of national legislatures but this will require further work and assessment. 

  * **Dimension 1.2: Data use by national executive branch:** Not included because of lack of established methodology. There are some usable data sources (as used by [@paris21_statistical_2019]) but gaps in data across countries have prevented full adoption.

  * **Dimension 1.3: Data use by civil society:** Not included because of lack of established methodology. There are some usable data sources with good coverage, for example from social media but more data is required to help assess and allow for likely biases between and within countries.

  * **Dimension 1.4: Data use by academia:** Not included because of lack of established methodology. We have not been able to find usable data sources with global coverage on which a new methodology could be developed.

  * **Dimension 1.5: Data use by international organizations:** Five measures of usefulness or reliability of country produced measures for international organizations have been included. First, on comparability of poverty estimates for the World Bank reporting on international poverty using  [Povcalnet](http://iresearch.worldbank.org/PovcalNet) ([@castaneda2020september]). Second on usable surveys for statistics on child mortality for the [UN Inter-agency Group for Child Mortality Estimation](https://childmortality.org/) ([@united2020levels]). Third on accuracy of debt reporting as classified by the World Bank (Source: World Bank WDI metadata).  Fourth, on availability of safely managed drinking water data for use by [WHO/UNICEF Joint Monitoring Programme](https://washdata.org/) ([@who2018jmp]).  Fifth, on labor force participation data for use by [ILO](https://www.ilo.org/ilostat-files/Documents/TEM.pdf). While these data sources provide only a partial coverag of data used by international organizations, they do provide an indication of the performance of the national statistical system.


  * **Dimension 2.1: Data Releases:** SDDS/e-GDDS subscription. This indicator is based on whether the country subscribes to IMF SDDS+, SDDS, or e-GDDS standards. The source is the IMF Dissemination Standards Bulletin Board. This is a reliable data source but we recognize that it is a proxy for the concept we are seeking to capture rather than a direct measurement.

  * **Dimension 2.2: Online access:** ODIN Open Data Openness score (Crowell et al). This is a well-established data source with good country coverage, which scores countries based on whether indicators are available online in a format that is machine readable, in a non-proprietary format, downloadable, with metadata available and terms of use. Scores range from 0-1. For more details, consult the [ODIN technical documentation](https://docs.google.com/document/d/1MBK0hN6MoQrii7_E1bmRXmsUcE8Fbb-Q32nxm8d8qTw/edit).

  * **Dimension 2.3: Advisory/ Analytical Services:** Not included because of lack of established methodology. This could be a new indicator of the number of non-recurring products on NSO website (ad hoc/experimental rather than regular releases). The indicator is the number of products found. No established source exists for this indicator.

  * **Dimension 2.4: Data access services:** NADA metadata. This indicator checks whether NADA microdata cataloging is available for surveys produced by NSO. NADA is an open source microdata cataloging system, compliant with the Data Documentation Initiative (DDI) and Dublin Cores RDF metadata standards. Source: NSO websites.

  * **Dimension 3.1: Social Statistics:** Availability of indicators for the Sustainable Development Goals 1-6, measured by an average score. The primary data source is the UN SDG database. While this is a database with comprehensive coverage that all countries have signed up to, many countries are not yet submitting all their available national data. For this reason, scores for some countries thus may not fully capture their performance in calculating the indicators. For OECD countries, we supplement the UN SDG database with comparable data submitted to the OECD following the methodology in M[Measuring Distance to the SDG Targets 2019: An Assessment of Where OECD Countries Stand](https://www.oecd.org/sdd/measuring-distance-to-the-sdg-targets-2019-a8caf3fa-en.htm). 

  * **Dimension 3.2: Economic Statistics:** Availability of Goal 7-12 indicators, measured by an average score. See 3.1. 

  * **Dimension 3.3: Environmental Statistics:** Availability of Goal 13 & 15 indicators, measured by an average score. Goal 14 - Life on Water - is not included because land-locked countries do not report on these indicators. See 3.1.

  * **Dimension 3.4: Institutional Statistics:** Availability of Goal 16-17 indicators measured by an average score. See 3.1.

  * **Dimension 4.1: Censuses and Surveys:** Availability of recent censuses and surveys covering broad areas. The following censuses and surveys are considered: Population & Housing census, Agriculture census, Business/establishment census, Household Survey on income/ consumption/ expenditure/ budget/ Integrated Survey, Agriculture survey, Labor Force Survey, Health/Demographic survey, Business/establishment survey. Source: NSO websites, World Bank microdata library, ILO microdata library, IHSN microdata library.

  * **Dimension 4.2: Administrative Data:** Availability of Civil Registration and Vital Statistics (CRVS) indicator. An ideal indicator for this dimension would include a score based on the density of administrative data available in sectors including social protection, education, labor, and health. However, social protection, education, health, and labor admin data indicators are not included because of lack of established methodology. While several promising sources for administrative data from the World Bank’s ASPIRE team, WHO, UNESCO, and ILO have been identified, these were not included due to incomplete coverage across countries. Further research and data collection effort would be needed to fill in this information, so that a more comprehensive picture of administrative data availability can be produced. 

  * **Dimension 4.3: Geospatial Data:** Geospatial data available at 1st Admin Level. This data source from Open Data Watch focuses on data availability at the sub-national level and provides a partial understanding of a country’s ability to produce geospatial data. A research and data collection effort is needed to develop a more comprehensive global database of the availability of key geospatial indicators. 

  * **Dimension 4.4: Private/citizen generated data:** Not included because of lack of established methodology. Currently no comprehensive source exists to measure the use of private and citizen generated data in national statistical systems, and this should be another area where more data collection is needed by the international community.

  * **Dimension 5.1: Legislation and governance:** This indicator is based on PARIS21 indicators on SDG 17.18.2 (national statistical legislation compliance with UN Fundamental Principles of Official Statistics), existence of National Statistical Council, national statistical strategy generation, national statistical plan. Limited country coverage makes cross country comparison limited. As a result, this is included in the dashboard, but not in the overall SPI score or index.

  * **Dimension 5.2: Standards and Methods:** This set of indicators is based on countries’ use of internationally accepted and recommended methodologies, classifications and standards regarding data integration. These indicators help facilitate data exchange and provide the foundation for the preparation of relevant statistical indicators. The following methods and standards are considered: System of national accounts in use, National Accounts base year, Classification of national industry, CPI base year, Classification of household consumption, Classification of status of employment, Central government accounting status, Compilation of government finance statistics, Compilation of monetary and financial statistics, Business process. Further work could improve the validity of this indicator and reduce the risk that countries may be incentivized to adopt only traditional standards and methods and neglect innovative solutions that may be more valid in the current context. 

  * **Dimension 5.3: Skills:** Not included because of lack of established methodology or suitable data sources. A new indicator drawing on PARIS21 indicators such as statistical society presence and data literacy could be developed and is an area of future work.

  * **Dimension 5.4: Partnerships:** Not included because of lack of established methodology or suitable data sources. A new indicator based on textual analysis of NSS reports/websites for references to partner organizations could be developed. This is an area of future work.

  * **Dimension 5.5: Finance:** The indicator is based on PARIS21 SDG indicators (SDG 17.18.3 (national statistical plan that is fully funded and under implementation). It is included in dashboard, but not in the overall SPI score or index because of insufficient country coverage. For more details: [@yu_tian_partner_2020]. 





  

## Data gaps

The approach taken to the development of the SPI has been to start with a *first* best framework and then try and find suitable indicators to help measure progress against that framework. This has revealed a significant number of data gaps. In many critical areas of national statistical system performance, at present there is no available data to construct measures. This calls for a substantial research agenda, requiring a wide range of countries, international agencies and other organizations to work together to produce globally comparable, comprehensive, consistent and transparent information about national statistical systems.

An area of particular concern is the pillar of data use. Currently, the dashboard only features indicators for one of the five dimensions of data use, which is data use by international organizations. Indicators on whether statistical systems are providing useful data to their national governments (legislature and executive branches), to civil society, and to academia are absent.  Thus the dashboard does not yet assess if national statistical systems are meeting the data needs of a large swathe of users. 

Under the pillar of data services an area that needs improvement is the measurement of advisory and analytical services provided by NSOs, such as data stewardship services. By measuring this type of work done by NSOs that goes beyond producing data, the international community and the NSOs themselves can better assess whether this type of support is in place.

In the data sources pillar, more information is needed in the areas of administrative data, geospatial data, and private and citizen generated data. On administrative data, the picture is incomplete with no measures of whether countries have administrative data systems in place to measure health, education, labor, and social protection program statistics. For the geospatial indicator, there is a proxy measure of whether the country is able to produce indicators at the sub-national level, but as yet, no understanding of how countries are using geospatial information in other ways, for instance using satellite data. And while the world is increasingly awash with private and citizen generated data (e.g., on mobility, job search, or social networking), on a global scale there is no reliable source to measure how national statistical systems are incorporating this information.

Finally, several of the 'soft' components of the data infrastructure pillar lack adequate data. This includes the areas of skills and of partnerships between entities in the national statistical system. The dashboard makes use of the PARIS21 led SDG indicator on whether the statistical legislations in countries met the standards of the UN Fundamental Principles of Statistics, but this was not incorporated into the overall SPI score, because of inadequate country coverage. This is also true of the PARIS21 led SDG indicator on whether the national statistical system is fully funded. Countries would need to be encouraged to report on this information.




## Data sources

The SPI draws on a variety of data sources to create the indicators.  A guiding principle is that the SPI rely on openly available data from credible sources, such as international organizations and NSO websites. The SPI team used web scraping, accessed publicly available databases, or in some cases visited NSO websites to acquire the information. While greater detail for each specific indicator can be found in the [technical documentation](https://worldbank.github.io/SPI/) describing each indicator, a general overview is provided here.

For pillar 1 on data use, data is collected from four distinct sources. The World Bank supplies data for indicators on availability of comparable poverty data (from the World Bank’s [Povcalnet](http://iresearch.worldbank.org/PovcalNet/introduction.aspx) system), and the indicator on quality of debt service data (from the World Bank’s World Development Indicators or [WDI metadata](https://databank.worldbank.org/home)). Data on the availability of under 5 child mortality data comes from the [UN Inter-agency Group for Child Mortality Estimation](https://childmortality.org/). The indicator on availability of safely managed drinking water data is sourced from the [WHO/UNICEF Joint Monitoring Programme](https://washdata.org/). The indicator on the availability of source data for measuring labor force participation comes from the [ILO](https://www.ilo.org/ilostat-files/Documents/TEM.pdf). Each of these sources will be updated annually prior to each annual data release. The date the data is updated for each of these sources is available in our technical documentation.

For pillar 2 on data services, information on data dissemination subscription is collected from the [IMF’s Dissemination Standards Bulletin Board](https://dsbb.imf.org/). This and the WDI metadata follow the same update schedule and the release these two sources are identical. The online access indicator is sourced from the Open Data Watch ODIN openness score. The date of the data download is available in the technical description for this indicator. The indicator for data access services is based on (i) whether a portal is available, (ii) compliant with the Data Documentation Initiative (DDI) and with Dublin Core’s RDF metadata standards, and (iii) which has a listing of surveys and microdata sets that can provide the necessary data and reference for follow-up. This information is collected manually by visiting each NSO website.

For the data products dimension, indicators are generated using the UN Global SDG monitoring database. For each SDG indicator, the database is checked to see whether a value is available within a five year window. (for instance, for 2019 if a value is available between 2015-2019. For OECD countries, the UN SDG database is supplemented with comparable data submitted to the OECD following the methodology in [Measuring Distance to the SDG Targets 2019: An Assessment of Where OECD Countries Stand](https://www.oecd.org/sdd/measuring-distance-to-the-sdg-targets-2019-a8caf3fa-en.htm). The decision to supplement the UN Global SDG monitoring database using this OECD database was taken, because a clear methodology had been established to do so. The UN Global SDG monitoring database was chosen as a primary source, rather than individual NSO websites, because data submitted to the UN Global SDG monitoring database goes through a standardized process including quality control and detailed documentation.

For dimension 4, on censuses and surveys, two complementary approaches are taken to collecting data. The first is to make use of data submitted to the World Bank, IHSN, ILO, and FAO microdata libraries. Only surveys that are marked as nationally representative are used, and surveys are classified (as either health surveys, agriculture surveys, labor force surveys, etc.) using the classifications submitted to the microdata libraries. The contents of searches on these databases are available in the github repository. The second approach is a manual data collection effort, where NSO websites have been visited to be sure no surveys were missed. To be included in this search, the survey or census must be publicly available and accessible. If surveys or censuses are missed in this search, the easiest way for a country to get it included would be to create an entry for the survey at one of the microdata libraries. Information on the completeness of the Civil Registry and Vital Statistics (CRVS) is sourced from the UN SDG global monitoring database. Information on whether data is available at the 1st administrative level, for the geospatial indicator, is sourced from Open Data Watch, as is the data openness score.

For dimension 5, data on the legislation indicator and finance indicators (compiled by PARIS21) are pulled from the UN SDG global monitoring database. Indicators in the standards and methods pillar are sourced primarily through the IMF. Information on the system of national accounts in use and national accounts base year are sourced through the World Bank’s WDI metadata. Data for the business process indicator is sourced through the United Nations Industrial Development Organization (UNIDO) and the United Nations Economic Commission for Europe (UNECE).
A full description of each specific indicator is available in Appendix A6 and in the SPI github repository.  


A full description of each specific indicator is available in Appendix A6 and in the [SPI github repository](https://github.com/worldbank/SPI).  



# SPI Index Methodology 

An overall score is produced by combining the Statistical Performance Indicators to yield one single index. The statistical performance indicators have a nested structure, and the SPI overall score is formed by sequentially aggregating each level.

To begin we produce a score for each dimension, which, unless otherwise stated, is an unweighted average of the indicators within that dimension. For instance, the Standards and Methods dimension will be formed by taking the unweighted average of the indicators for the system of national accounts in use, national accounts base year, classification of national industry, CPI base year, classification of household consumption, etc.




$$ SPI.DIM_{ctpd} = \sum_{i=1}^{N_I} \frac{SPI.IND_{ctpdi}}{N_I} $$

where $SPI.DIM_{ctpd}$ is pillar p, in dimension d, in time period t, and country c.  $SPI.IND_{ctpdi}$ is an indicator (e.g. population census score).

After computing a score for each dimension, a score for each pillar is computed, as either an unweighted or weighted average of the dimensions in that pillar. For pillars 1, 2, 4, and 5, the unweighted average of the dimensions within each pillar is taken.  For pillar 3 on data products, we take a weighted average of the dimension scores, where the weights are based on the number of SDGs in each dimension (6 SDGs in dimension 3.1 on social statistics, 6 SDGs in dimension 3.2 on economic statistics, 2 in dimension 3.3 on environmental statistics, and 2 in dimension 3.4 on institutional statistics).^[SDG 14 - Life Below Water - is omitted because land-locked countries do not report on these indicators.]   This reflects a perspective that all SDGs are of equal importance, and therefore the dimensions are weighted accordingly. Additionally, for Pillar 4 on data sources, censuses and surveys are given separate weights, so that censuses, surveys, admin data, and geospatial data each receives a weight of 1/4. While censuses and surveys are in the same pillar in the framework, and therefore each would typically only receive a weight of 1/6 (for a total weight of 1/3) in this dimension, because of their importance in producing many indicators, they are given extra weight such that they each gets a weight of 1/4  (for a total weight of 1/2).

$$ SPI.PIL_{ctp} = \sum_{d=1}^{N_d} \frac{\omega_{pd} \times SPI.DIM_{ctpd}}{N_d} $$

$\omega_{pd}$ is the weight for dimension d in pillar p.

After calculating the scores for each pillar, the SPI overall score is derived by taking the simple average across the 5 pillars.

The SPI overall score has a maximum score of 100 and a minimum of 0. A score of 100 would indicate that a country has every single element that we measure. A score of 0 indicates that none are in available. To be precise:




$$ SPI.INDEX_{ct} = \sum_{p=1}^{N_p} \frac{SPI.PIL_{ctp}}{N_p} $$

Where SPI.INDEX is the SPI overall score. SPI.PIL are the 5 SPI pillars listed above. In the notation, c is a country, t is the date, p is a pillar  

The nested structure of our index and the summation methods used to build an overall score ensure the axiomatic properties outlined in [@cameron2021measuring].^[An earlier version of the journal publication was released as a World Bank Policy Research paper, [@cameron2019measuring]]   These properties include symmetry, monotonicity, and subgroup decomposability.  Symmetry refers to property where if the values of two indicators in a nesting are switched, then the resulting index scores are unaffected.  Monotonicity implies that if the value of an indicator improves, then the resulting index scores improve as well. Subgroup decomposability results from the fact that the scores are a weighted average of the subgroups (either indicators, dimensions, pillars) that make up that score and so can be written as a linear combination of those subgroups.

# SPI Overall Scores


```{r spi_df}

# This block of code will create a blank SPI dataset (only containing country info) that will be appended to when each indicator is added.
# There will be two indicators added for each pillar
# 1. An indicator with a score between 0-1 for each pillar
# 2. An indicator with the raw (unscored) values of the indicators
# The unit for this database will be country*year

span <- c(2004:end_date)

spi_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") # take out the aggregates (LAC, SAR, etc)

spi_df <- spi_df_empty

#read list of iso3c codes for matching from UN (https://unstats.un.org/unsd/methodology/m49/)
iso3c <- read_csv(paste(raw_dir,'metadata/iso_codes.csv', sep="/"),
                  col_types=list(col_character(), col_character(), col_character()))

```


```{r index_weights}

#Pillar 1 - Overall Weight
pillar_1 <- 1/5
#Dimension 1.5: Data Use by International Organizations
dim_1_5 <- 1

#Dimension 2 - Overall Weight
pillar_2 <- 1/5
#Dimension 2.1: Data releases
dim_2_1 <- 1/3
#Dimension 2.2: Online access
dim_2_2 <- 1/3
# Dimension 2.4: Data services
dim_2_4 <- 1/3

# Dimension 3 - Overall Weight
pillar_3 <- 1/5
# Dimension 3: SDG 1
dim_3_1 <- 1/16
# Dimension 3: SDG 2
dim_3_2 <- 1/16
# Dimension 3: SDG 3
dim_3_3 <- 1/16
# Dimension 3: SDG 4
dim_3_4 <- 1/16
# Dimension 3: SDG 5
dim_3_5 <- 1/16
# Dimension 3: SDG 6
dim_3_6 <- 1/16
# Dimension 3: SDG 7
dim_3_7 <- 1/16
# Dimension 3: SDG 8
dim_3_8 <- 1/16
# Dimension 3: SDG 9
dim_3_9 <- 1/16
# Dimension 3: SDG 10
dim_3_10 <- 1/16
# Dimension 3: SDG 11
dim_3_11 <- 1/16
# Dimension 3: SDG 12
dim_3_12 <- 1/16
# Dimension 3: SDG 13
dim_3_13 <- 1/16
# Dimension 3: SDG 15
dim_3_15 <- 1/16
# Dimension 3: SDG 16
dim_3_16 <- 1/16
# Dimension 3: SDG 17
dim_3_17 <- 1/16

#Dimension 4 - Overall Weight
pillar_4 <- 1/5
# Dimension 4.1: censuses and surveys
dim_4_1.CEN <- 1/4
dim_4_1.SVY <- 1/4
#Dimension 4.2: administrative data
dim_4_2 <- 1/4
# Dimension 4.3: geospatial data
dim_4_3 <- 1/4

# Dimension 5 - Overall Weight
pillar_5 <- 1/5
# Dimension 5.2: Standards and Methods
dim_5_1 <- 0
dim_5_2 <- 1
dim_5_5 <- 0


```
  

```{r index}
#get a list of oecd countries
oecd_country_query <-  GET(url = "https://api.worldbank.org/v2/country?region=OED&format=json") %>%
  content( as = "text", encoding = "UTF-8") %>%
  jsonlite::fromJSON( flatten = TRUE) 

#do some conversion to produce a dataframe
oecd_country_df <- oecd_country_query[[2]] %>%
  as_tibble() 
  

# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region, weights, population) %>%
  arrange(-date,country)

#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  mutate(SPI.D4.3.GEO.first.admin.level=if_else(SPI.D4.3.GEO.first.admin.level<SPI.D4.3.GEO.second.admin.level,SPI.D4.3.GEO.second.admin.level, SPI.D4.3.GEO.first.admin.level )) %>% # some countries report data at 2nd admin level but not first.  This change addresses this fact, so that countries are given credit is they report at geographic level lower than 1st admin level.
  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level) 





#first index 
# just take a simple numeric average across all indicators
# I will forward fill all indicators if they are missing
spi_index_simple <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  select(-starts_with("SPI.D1")) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(SPI.INDEX=rowMeans(across(starts_with("SPI")), na.rm=FALSE),
         SPI.INDEX.PIL2=rowMeans(across(starts_with("SPI.D2")), na.rm=FALSE),
         SPI.INDEX.PIL3=rowMeans(across(starts_with("SPI.D3")), na.rm=FALSE),
         SPI.INDEX.PIL4=rowMeans(across(starts_with("SPI.D4")), na.rm=FALSE),
         SPI.INDEX.PIL5=rowMeans(across(starts_with("SPI.D5")), na.rm=FALSE)
         ) %>% #
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything())


#################
# Nested Index
################
spi_index_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  select(country, iso3c, date, everything())



#recalculate index based on the weights
pillar_total <- pillar_1 + pillar_2 + pillar_3 + pillar_4 + pillar_5
pillar2_total <- dim_2_1 + dim_2_2 + dim_2_4
pillar3_total <- 
  dim_3_1 + 
  dim_3_2 +
  dim_3_3 +
  dim_3_4 +
  dim_3_5 +
  dim_3_6 +
  dim_3_7 +
  dim_3_8 +
  dim_3_9 +
  dim_3_10 +
  dim_3_11 +
  dim_3_12 +
  dim_3_13 +
  dim_3_15 +
  dim_3_16 +
  dim_3_17
pillar4_total <- dim_4_1.CEN + dim_4_1.SVY + + dim_4_2 + dim_4_3
pillar5_total <- dim_5_1 + dim_5_2 + dim_5_5

#create index dataset
spi_index_df <- spi_index_df %>%
  mutate(SPI.DIM1.5.INDEX=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.DIM2.1.INDEX=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2.INDEX=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4.INDEX=SPI.D2.4.NADA,
         SPI.DIM3.1.INDEX=rowMeans(across(c("SPI.D3.1.POV",
                                          "SPI.D3.2.HNGR",
                                          "SPI.D3.3.HLTH",
                                          "SPI.D3.4.EDUC",
                                          "SPI.D3.5.GEND",
                                          "SPI.D3.6.WTRS"))),
         SPI.DIM3.2.INDEX=rowMeans(across(c("SPI.D3.7.ENRG",
                                          "SPI.D3.8.WORK",
                                          "SPI.D3.9.INDY",
                                          "SPI.D3.10.NEQL",
                                          "SPI.D3.11.CITY",
                                          "SPI.D3.12.CNSP"))),         
         SPI.DIM3.3.INDEX=rowMeans(across(c("SPI.D3.13.CLMT",
                                          "SPI.D3.15.LAND" ))),
         SPI.DIM3.4.INDEX=rowMeans(across(c("SPI.D3.16.INST",
                                          "SPI.D3.17.PTNS" ))),
         SPI.DIM4.1.CEN.INDEX=rowMeans(across(c('SPI.D4.1.1.POPU','SPI.D4.1.2.AGRI','SPI.D4.1.3.BIZZ'))), #separate census and surveys 
         SPI.DIM4.1.SVY.INDEX=rowMeans(across(c('SPI.D4.1.4.HOUS','SPI.D4.1.5.AGSVY','SPI.D4.1.6.LABR', 'SPI.D4.1.7.HLTH','SPI.D4.1.8.BZSVY'))), #separate census and surveys 
         SPI.DIM4.2.INDEX=rowMeans(across(starts_with('SPI.D4.2'))),
         SPI.DIM4.3.INDEX=rowMeans(across(starts_with('SPI.D4.3'))),
         
         SPI.DIM5.1.INDEX=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.1.INDEX=if_else(is.na(SPI.DIM5.1.INDEX),-99,SPI.DIM5.1.INDEX),
         
         SPI.DIM5.2.INDEX=rowMeans(across(starts_with('SPI.D5.2'))),
         
         SPI.DIM5.5.INDEX=rowMeans(across(starts_with('SPI.D5.5'))),
         SPI.DIM5.5.INDEX=if_else(is.na(SPI.DIM5.5.INDEX),-99,SPI.DIM5.5.INDEX) 
             ) %>%
  mutate(
    SPI.INDEX.PIL1=SPI.DIM1.5.INDEX,
    SPI.INDEX.PIL2=(
      (dim_2_1/pillar2_total)*SPI.DIM2.1.INDEX +
        (dim_2_2/pillar2_total)*SPI.DIM2.2.INDEX +
        (dim_2_4/pillar2_total)*SPI.DIM2.4.INDEX )
    ,
    SPI.INDEX.PIL3=(
      (dim_3_1/pillar3_total)*SPI.D3.1.POV +
        (dim_3_2/pillar3_total)*SPI.D3.2.HNGR +
        (dim_3_3/pillar3_total)*SPI.D3.3.HLTH +
        (dim_3_4/pillar3_total)*SPI.D3.4.EDUC +
        (dim_3_5/pillar3_total)*SPI.D3.5.GEND +
        (dim_3_6/pillar3_total)*SPI.D3.6.WTRS +
        (dim_3_7/pillar3_total)*SPI.D3.7.ENRG +
        (dim_3_8/pillar3_total)*SPI.D3.8.WORK +
        (dim_3_9/pillar3_total)*SPI.D3.9.INDY +
        (dim_3_10/pillar3_total)*SPI.D3.10.NEQL +
        (dim_3_11/pillar3_total)*SPI.D3.11.CITY +
        (dim_3_12/pillar3_total)*SPI.D3.12.CNSP +
        (dim_3_13/pillar3_total)*SPI.D3.13.CLMT +
        (dim_3_15/pillar3_total)*SPI.D3.15.LAND +
        (dim_3_16/pillar3_total)*SPI.D3.16.INST +
        (dim_3_17/pillar3_total)*SPI.D3.17.PTNS)
    ,
    SPI.INDEX.PIL4=(
      (dim_4_1.CEN/pillar4_total)*SPI.DIM4.1.CEN.INDEX +
      (dim_4_1.SVY/pillar4_total)*SPI.DIM4.1.SVY.INDEX +
        (dim_4_2/pillar4_total)*SPI.DIM4.2.INDEX +
        (dim_4_3/pillar4_total)*SPI.DIM4.3.INDEX )
    ,
    SPI.INDEX.PIL5=(
      (dim_5_1/pillar5_total)*SPI.DIM5.1.INDEX +
        (dim_5_2/pillar5_total)*SPI.DIM5.2.INDEX +
        (dim_5_5/pillar5_total)*SPI.DIM5.5.INDEX ),
    SPI.INDEX=(pillar_1/pillar_total)*SPI.INDEX.PIL1 +
      (pillar_2/pillar_total)*SPI.INDEX.PIL2 +
      (pillar_3/pillar_total)*SPI.INDEX.PIL3 +
      (pillar_4/pillar_total)*SPI.INDEX.PIL4 +
      (pillar_5/pillar_total)*SPI.INDEX.PIL5 
    #sum up based on individual dimension weights
  ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'),starts_with('SPI.DIM'), everything()) 
  #  filter(date>=2016) #2016 is first year with complete data

  
#display top 25
index_disp <- spi_index_df %>%
  ungroup() %>%
  filter(date==end_date) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~1*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'))


```



```{r saver, include=FALSE}


spi_index_df %>%
  write_excel_csv(path=paste(output_dir, 'SPI_index.csv', sep="/"))

#add stata labels and save a stata version
#read in the data labels
metadata_info <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep="")) %>%
    mutate(descript=paste(SPI_indicator_id,": ", spi_indicator_name," - ",source_name , sep="")) %>%
    select(source_id,  descript, spi_indicator_description)

metadata_info <- read_csv(paste(raw_dir, '/metadata/SPI_index_sources.csv', sep="")) %>%
  bind_rows(metadata_info)

#create a copy of the data to save to stata
spi_index_dta <- spi_index_df

#get a list of the labels and apply them
labels <- metadata_info[match(colnames(spi_index_dta),metadata_info$source_id),2]
labels <- labels$descript
names(labels) <-colnames(spi_index_dta)
  
label(spi_index_dta) <- as.list(labels)

#save stata compatible version with labels
spi_index_dta %>%
  janitor::clean_names() %>%
  haven::write_dta(path=paste(output_dir, 'SPI_index.dta', sep="/"))

#save a copy with column labels as well to csv
l <- lapply(spi_index_dta, attr, "label") # Gives you list of the labeled variables
l <- as.data.frame(l, stringsAsFactors = F) # Convert list to dataframe
spi_index_dta_lab <- rbind(l, spi_index_dta) %>%
  write_excel_csv(path=paste(output_dir, 'SPI_index_labelled.csv', sep="/"),
                  na="") # Bind the two


#for rest of paper, restrict to just 2016, which is where we have complete data
spi_index_df <- spi_index_df %>%
  filter(date>=2016)

```


```{r text_computations}

#number of countries with data for SPI overall score
n_countries <- spi_index_df %>%
  filter(!is.na(SPI.INDEX) & date==end_date) %>% #countries with value for SPI in end_date
  nrow()

# percentage of world population covered
pop_covered <- spi_index_df %>%
  filter(date==end_date) %>%
  mutate(covered=!is.na(SPI.INDEX)) %>%
  mutate(covered_pop=if_else(covered==TRUE, population, 0)) %>%
  ungroup() %>%
  summarise(pop_covered=sum(covered_pop, na.rm=T)/sum(population, na.rm=T))


```


The purpose of the SPI is to help countries assess and improve the performance of their statistical systems. The presentation of SPI overall scores is designed to reflect that aim. Small differences between countries should not be highlighted since they can reflect imprecision arising from the currently available indicators rather than meaningful differences in performance. Instead, the presentation of overall SPI scores focuses on larger groupings of countries reflecting broad categories of performance as measured by the indicator framework.   In total, there are `r n_countries` countries with sufficient data to compute an index value.  This set of countries covers `r 100*round(pop_covered$pop_covered,3)` percent of the world population.

The map is color coded based on the performance of countries on our index.  Given the imprecision inherent in the calculations we recommend that the color coding provides the most detailed subdivisions of maturity. Finer distinctions are unlikely to provide meaningful differentiation between countries. 

Countries are grouped into five categories as shown on the map in figure 6.1:

* **Top Quintile**:  Countries in the top 20% of the SPI overall score (shading in <span style="color:#2ec4b6">dark green</span>).   

* **4th Quintile**: Countries in the 4th quintile, or those above the 60th percentile but below the 80th percentile (<span style="color:#acece7">light green</span>).    

* **3rd Quintile**: Countries in the 3rd quintile, or those between the 40th and 60th percentile (shading in <span style="color:#f1dc76">yellow</span>).

* **2nd Quintile**: Countries in the 2nd quintile, or those above the 20th percentile but below the 40th percentile (shading in <span style="color:#ffbf69">light orange</span>).  

* **Bottom 20%**: Countries in the bottom 20% (shading in <span style="color:#ff9f1c">dark orange </span>).  


*Figure 6.1: SPI Overall Score by Quintile in `r end_date`*
```{r map}
#show map and summary stats by region and income group

spi_mapper('spi_index_df','SPI.INDEX','')

```


```{r maturitytabovr}

indicators<-c("SPI.INDEX","SPI.INDEX.PIL1","SPI.INDEX.PIL2","SPI.INDEX.PIL3",
              "SPI.INDEX.PIL4","SPI.INDEX.PIL5")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])

pil1_top <- as.numeric(maturity_tab[2,2])
pil1_bottom <- as.numeric(maturity_tab[2,6])

pil3_top <- as.numeric(maturity_tab[4,2])
pil3_bottom <- as.numeric(maturity_tab[4,6])

```


The countries scoring in the top 20% have an average SPI overall score  of `r spi_top`.  A maximum score of 100 would indicate that a country has every single element in place that is measured through the SPI.   Meanwhile, countries in the bottom 20% score significantly worse, with average  scores  of `r spi_bottom`.  In Pillar 1, countries in the top quintile have a score of `r pil1_top`, while countries in the bottom quintile have scores of `r pil1_bottom`.  One area where even top quintile countries are not doing as well as possible is on our data products pillar.  Countries in the top quintile score only `r pil3_top` points out of 100 in this area.  Pillar 3 measures whether countries have a value in the past 5 years for each SDG indicator, meaning even the top quintile countries have only around `r pil3_top`% of indicators averaging over the SDGs.

*Table 6.1: Table of SPI Overall and Pillar Scores by Quintile Group in `r end_date`*
```{r maturitdisp0}

maturity_tab <- maturity_tab %>%
  flextable() 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```


```{r maturitytabcont}

indicators<-c("SPI.INDEX","SPI.D1.5.DT.TDS.DPPF.XP.ZS","SPI.D2.2.Openness.subscore","SPI.D3.1.POV",
             "SPI.D4.1.1.POPU","SPI.D5.2.4.CPIBY")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 



debt_top <- as.numeric(maturity_tab[2,2])
debt_bottom <- as.numeric(maturity_tab[2,6])

census_top <- as.numeric(maturity_tab[5,2])
census_bottom <- as.numeric(maturity_tab[5,6])

```




To highlight a few specific indicators, countries in the top 20% on average get nearly perfect scores in terms of the debt reporting to the World Bank.  The top 20% of countries in the SPI overall score have an average score on their debt reporting of `r debt_top`, with a maximum score of 1 and minimum score of 0, while those in the bottom 20% on the SPI overall score have an average score of `r debt_bottom`.  To take another  example, when looking at scores on whether a population census has been conducted recently, countries in the top 20% score on average `r census_top` on our population census indicator, with a max score of 1 and minimum score of 0, while those in the bottom 20% on our SPI overall score receive `r census_bottom` points on the population census indicator.  The table below shows differences across maturity groups for a select set of indicators.

*Table 6.2: Table of SPI Overall and Select SPI Indicators by Quintile Group in `r end_date`*
```{r maturitdisp}

maturity_tab <- maturity_tab %>%
  flextable() 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```


## SPI Overall Score by Region and Income Group

There are large differences in the SPI overall score across World Bank regions and income groups.  Overall, North America has the highest average overall SPI score, while the Sub-Saharan Africa region has the lowest average score.^[All tables and figures show unweighted summary statistics (i.e. the summary statistics do not weight by population).] There is also a clear gradient with respect to income groups.  Countries classified as low income have lower scores on average than countries classified as middle income.  High income countries have the highest average SPI overall score.  

Finally, when looking over time, since 2016 the SPI overall score values are relatively stable across regions.  There has been some modest increase in the SPI overall score scores for middle income and high income countries, with little progress for low income countries.

*Figure 6.2.A: SPI Overall Score by Region in `r end_date`*
```{r spiregcharts}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX','SPI Overall Score')

```

*Figure 6.2.B: SPI Overall Score by Income Group in `r end_date`*
```{r spiincomecharts}
#show map and summary stats by region and income group

spi_income_charts('spi_index_df','SPI.INDEX','SPI Overall Score')

```

*Figure 6.2.C: SPI Overall Score by Lending Group in `r end_date`*
```{r spilendcharts}
#show map and summary stats by region and income group

lending_chart_aggregate('spi_index_df','SPI.INDEX','SPI Overall Score')

```

*Figure 6.2.D: SPI Overall Score by Fragile/Conflict Situation Status in `r end_date`*
```{r spifcscharts}
#show map and summary stats by region and income group

fcs_chart_aggregate('spi_index_df','SPI.INDEX','SPI Overall Score')

```

*Figure 6.2.E: SPI Overall Score by Year (2016-19)*
```{r spitimecharts}
#show map and summary stats by region and income group

spi_time_charts('spi_index_df','SPI.INDEX','SPI Overall Score')

```


```{r regionheterogeneity}
#LAC
lac_df <- spi_index_df %>%
  filter(date==end_date) %>%
  filter(region=="Latin America & Caribbean") %>%
  select(country, SPI.INDEX) %>%
  filter(!is.na(SPI.INDEX))

top_lac <- as.character(lac_df[1,1])
top_lac_score <- round(as.numeric(lac_df[1,2]),1)

bottom_lac <- as.character(lac_df[nrow(lac_df),1])
bottom_lac_score <- round(as.numeric(lac_df[nrow(lac_df),2]),1)

#SSA
ssa_df <- spi_index_df %>%
  filter(date==end_date) %>%
  filter(region=="Sub-Saharan Africa") %>%
  select(country, SPI.INDEX) %>%
  filter(!is.na(SPI.INDEX))

top_ssa <- as.character(ssa_df[1,1])
top_ssa_score <- round(as.numeric(ssa_df[1,2]),1)

bottom_ssa <- as.character(ssa_df[nrow(ssa_df),1])
bottom_ssa_score <- round(as.numeric(ssa_df[nrow(ssa_df),2]),1)

#EAP
eap_df <- spi_index_df %>%
  filter(date==end_date) %>%
  filter(region=="East Asia & Pacific") %>%
  select(country, SPI.INDEX) %>%
  filter(!is.na(SPI.INDEX))

top_eap <- as.character(eap_df[1,1])
top_eap_score <- round(as.numeric(eap_df[1,2]),1)

bottom_eap <- as.character(eap_df[nrow(eap_df),1])
bottom_eap_score <- round(as.numeric(eap_df[nrow(eap_df),2]),1)

```

As well as large differences across regions, there is significant variation in the SPI overall scores within regions.   For instance, in the Latin America & Caribbean World Bank region, `r top_lac` is the highest scoring country with a score of `r top_lac_score`.  However, `r bottom_lac`, the lowest scoring country in the region, earns a substantially lower score of `r bottom_lac_score`.  In Sub-Saharan Africa, the highest scoring country is `r top_ssa` with a score of `r top_ssa_score`, while the lowest scoring country is `r bottom_ssa` with a score of `r bottom_ssa_score`.  In the East Asia and Pacific region, the top scoring country is `r top_eap` with a score of `r top_eap_score`, while the lowest scoring country is `r bottom_eap` with a score of `r bottom_eap_score`.

*Figure 6.3: SPI Overall Scores by Country and Region in `r end_date`* 
```{r spicountrycharts}
#show map and summary stats by region and income group

spi_country_charts('spi_index_df','SPI.INDEX','SPI Overall Score')

```

## SPI Scores by Pillar

By presenting scores for each of the pillars – data use, data services, data products, data sources, and data infrastructure – that compose the SPI overall score, it is possible to show where variation across countries is coming from and to assess the specific areas in which countries may be struggling


### Pillar 1: Data Use

Figure 6.4 shows a world map displaying countries based on data use score quintiles Overall, the high income countries in North America and Europe tend to rate most highly along this dimension, whereas Sub Saharan African countries tend to lag.  

*Figure 6.4: Pillar 1: Data Use Scores by Quintile in `r end_date`* 
```{r pillarsplot1}

spi_mapper('spi_index_df','SPI.INDEX.PIL1','Pillar 1: Data Use Scores')

```

Countries within region show significant dispersion in performance . It is worth noting that several countries such as  the United States, Mexico, Finland, and Costa Rica, among others, receive the maximum possible score in this dimension of 100. Several countries score the minimum score as well, including the Syrian Arab Republic, South Sudan, Namibia, and Nauru, among others.

*Figure 6.5: Pillar 1: Data Use Scores by Country and Region in `r end_date`* 
```{r countrypillarsplot1}

spi_country_charts('spi_index_df','SPI.INDEX.PIL1','Pillar 1: Data Use Scores')

```

```{r maturitytable1}

indicators<-c("SPI.INDEX.PIL1","SPI.D1.5.POV","SPI.D1.5.CHLD.MORT","SPI.D1.5.DT.TDS.DPPF.XP.ZS", "SPI.D1.5.SAFE.MAN.WATER", "SPI.D1.5.LFP")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])

poverty_top <- as.numeric(maturity_tab[2,2])
poverty_bottom <- as.numeric(maturity_tab[2,6])

mort_top <- as.numeric(maturity_tab[3,2])
mort_bottom <- as.numeric(maturity_tab[3,6])

debt_top <- as.numeric(maturity_tab[4,2])
debt_bottom <- as.numeric(maturity_tab[4,6])

```




The table below shows the average score on each indicator in pillar 1.  Countries in the top 20% possess nearly all of the components in pillar 1, while countries in the bottom 20% are lacking in many areas.  Countries in the bottom 20%  have an average of `r poverty_bottom` on the comparable poverty estimate indicator, an average of `r mort_bottom` on the availability of under 5 mortality data, and an average of `r debt_bottom` on debt reporting.

*Table 6.3: Select Pillar 1 Indicator Scores by SPI Overall Score Quintile Group in `r end_date`*
```{r maturitdisp1}

maturity_tab <- maturity_tab %>%
  flextable() 
  #add_header_lines('Select SPI Indicator Scores by SPI pillar Quintile Group') 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```

### Pillar 2: Data Services

For pillar 2 on data services, high income countries tend to score highest along this pillar  India, Morocco, and the Philippines scored highly as well in this pillar. This pillar contains four indicators on the quality of data releases, online accessibility, advisory and analytical services (not included due to lack of data), and the availability and use of data access services.   

*Figure 6.6: Pillar 2: Data Services Scores by Quintile in `r end_date`* 
```{r pillarsplot2}
spi_mapper('spi_index_df','SPI.INDEX.PIL2','')

```



*Figure 6.7: Pillar 2: Data Services Scores by Country and Region in `r end_date`* 
```{r countrypillarsplot2}

spi_country_charts('spi_index_df','SPI.INDEX.PIL2','')



```
```{r maturitytable2}

indicators<-c("SPI.INDEX.PIL2","SPI.D2.1.GDDS",
              "SPI.D2.2.Openness.subscore",
              "SPI.D2.2.Machine.readable",      "SPI.D2.2.Non.proprietary",
              "SPI.D2.2.Download.options",      "SPI.D2.2.Metadata.available",
              "SPI.D2.2.Terms.of.use",
              "SPI.D2.4.NADA")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])

sdds_top <- as.numeric(maturity_tab[2,2])
sdds_bottom <- as.numeric(maturity_tab[2,6])

open_top <- as.numeric(maturity_tab[8,2])
open_bottom <- as.numeric(maturity_tab[8,6])

machine_bottom <- as.numeric(maturity_tab[3,6])

nada_bottom <- as.numeric(maturity_tab[9,6])

```


In terms of specific indicators, the top 20% of countries receive an average score of `r sdds_top` on the indicator measuring country adoption of the IMF's data dissemination standards, while those in the bottom 20% receive an average score of `r sdds_bottom`.  Countries in the bottom 20% receive an average data openness score, produced by Open Data Watch, of `r open_bottom`.  This indicator is made up of several sub-indicators including whether data is available in machine readable format, a non-proprietary format, has download options, metadata available, and terms of use.  For instance, in the bottom 20% of countries the score on whether data is available in a machine readable format is only `r machine_bottom` out of a maximum of 1.  Additionally, countries in the bottom 20% only score an average of `r nada_bottom` on the measure of whether metadata meeting the standards of the Database Documentation Initiative (DDI) is available on surveys conducted.^[For more information, see https://ddialliance.org/]


*Table 6.4: Select Pillar 2 Indicator Scores by SPI Overall Score Quintile Group in `r end_date`*
```{r maturitdisp2}

maturity_tab <- maturity_tab %>%
  flextable() %>%
  padding(i=4:8,j=1,
          padding.left=20)
  # add_header_lines('Select SPI Indicator Scores by SPI Pillar 2 Quintile Group') 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```

### Pillar 3: Data Products



The data products pillar is based on whether countries are reporting data to monitor the SDGs. The SDG goals and targets provide a comprehensive, internationally agreed framework, encompassing indicators reflecting all domains of official statistics: economic, social, environmental and institutional which is relevant to all nations. For this pillar, indicators are produced using the UN Global SDG monitoring database. For each SDG indicator, a value is checked for availability within a five year window of a particular year.  For instance, for 2019, is any indicator value available between the years 2015-2019.

For this indicator, there is a weaker relationship between a country's income level and their performance in this pillar.  No countries receive a maximum score of 100, which would indicate that they report on every SDG indicator at least once inside a 5 year window.  Additionally, no country scores 0, which would indicate that they have reported no information for any of the SDG indicators.

The results for this pillar reflect two important aspects of the performance of a national statistical system, both of which need to be in place for a good score. First, do the SDG indicators required by the globally agreed framework exist for that country? And second, are those indicators available, in the agreed formats, on the UN Global SDG monitoring database? It is likely that some countries are producing more indicators but are not making them available through an internationally comparable database.  For OECD countries, we supplemented the UN SDG database with comparable data submitted to the OECD following the methodology in [@oecdsdg]. The UN Global SDG monitoring database has been supplemented using this OECD database, because a clear methodology had been established to do so.  Even with this supplemental data from the OECD included, there is considerable room for improvement in reporting on the SDGs.

Indicator values that are either country reported, country adjusted, estimated, or is included as global monitoring data are included. Values that were produced by an international organization through modeling are excluded. These classifications are based on the UN SDG metadata, where for each value of the indicator, the responsible international agency has been requested to indicate whether the national data were adjusted, estimated, modeled or are the result of a harmonized global monitoring exercise. The “nature” of the data classification in the SDG database is determined as follows:

  * Country data (C): Produced and disseminated by the country (including data adjusted by the country to meet international standards);

  * Country data adjusted (CA): Produced and provided by the country, but adjusted by the international agency for international comparability to comply with internationally agreed standards, definitions and classifications;

  * Estimated (E): Estimated based on national data, such as surveys or administrative records, or other sources but on the same variable being estimated, produced by the international agency when country data for some year(s) is not available, when multiple sources exist, or when there are data quality issues;

  * Modeled (M): Modeled by the agency on the basis of other covariates when there is a complete lack of data on the variable being estimated;

  * Global monitoring data (G): Produced on a regular basis by the designated agency for global monitoring, based on country data. There is no corresponding figure at the country level.

*Figure 6.8: Pillar 3: Data Products Scores by Quintile in `r end_date`*
```{r pillarsplot3}
spi_mapper('spi_index_df','SPI.INDEX.PIL3','Pillar 3: Data Products Scores')

```



```{r aggpillarsplot3, eval=FALSE, include=FALSE}

spi_charts('spi_index_df','SPI.INDEX.PIL3','Pillar 3: Data Products Scores')



```

*Figure 6.9: Pillar 3: Data Products Scores by Country and Region in `r end_date`* 
```{r countrypillarsplot3}

spi_country_charts('spi_index_df','SPI.INDEX.PIL3','Pillar 3: Data Products Scores')



```


```{r maturitytable3}

indicators<-c("SPI.INDEX.PIL3","SPI.D3.1.POV",
              "SPI.D3.2.HNGR",
              "SPI.D3.3.HLTH",
              "SPI.D3.4.EDUC",
              "SPI.D3.5.GEND",
              "SPI.D3.6.WTRS",
              "SPI.D3.7.ENRG",
              "SPI.D3.8.WORK",
              "SPI.D3.9.INDY",
              "SPI.D3.10.NEQL",
              "SPI.D3.11.CITY",
              "SPI.D3.12.CNSP",
              "SPI.D3.13.CLMT",
              "SPI.D3.15.LAND",
              "SPI.D3.16.INST",
              "SPI.D3.17.PTNS")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])

goal1_top <- as.numeric(maturity_tab[2,2])
goal1_bottom <- as.numeric(maturity_tab[2,6])

open_top <- as.numeric(maturity_tab[8,2])
open_bottom <- as.numeric(maturity_tab[8,6])

machine_bottom <- as.numeric(maturity_tab[3,6])

nada_bottom <- as.numeric(maturity_tab[9,6])

```


Even countries in the top quintile have significant room for improvement in reporting on the SDGs.  The average score for the top 20% of countries is `r spi_top`, while for the bottom 20% it is `r spi_bottom`.  For a specific goal, such as for SDG 1 on poverty, the top 20%  receives an average of `r goal1_top` out of a maximum of 1.  This means that the top performing countries are only reporting on `r 100*goal1_top` percent of the SDG indicators between 2015-19.  The bottom 20% receive an average score of `r goal1_bottom`.  The table below shows the full set of breakdowns by SDGs, suggesting reporting on SDG 5 on Gender lags other goals.


*Table 6.5: Select Pillar 3 Indicator Scores by SPI Overall Score Quintile Group in `r end_date`*
```{r maturitdisp3}

maturity_tab <- maturity_tab %>%
  flextable() 
  # add_header_lines('Select SPI Indicator Scores by SPI Pillar 2 Quintile Group') 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```



```{r index_3alt, eval=FALSE, include=FALSE}



#################
# Nested Index with high income, OECD countries top coded
################
  spi_index_df_dim3_alt <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  select(country, iso3c, date, everything()) %>%
  mutate(across(starts_with("SPI.D3"),
                ~if_else(( (income=='High income')  & (country %in% oecd_country_df$name)),1,.)                )) 



#Create overall subscores corresponding to John's framework
  spi_index_df_dim3_alt <- spi_index_df_dim3_alt %>%
    mutate(SPI.DIM2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4=SPI.D2.4.NADA,
         SPI.DIM3.1=rowMeans(across(c("SPI.D3.1.POV",
                                            "SPI.D3.2.HNGR",
                                            "SPI.D3.3.HLTH",
                                            "SPI.D3.4.EDUC",
                                            "SPI.D3.5.GEND",
                                            "SPI.D3.6.WTRS"))),
         SPI.DIM3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                            "SPI.D3.8.WORK",
                                            "SPI.D3.9.INDY",
                                            "SPI.D3.10.NEQL",
                                            "SPI.D3.11.CITY",
                                            "SPI.D3.12.CNSP"))),         
         SPI.DIM3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                            "SPI.D3.15.LAND" ))),
         SPI.DIM3.4=rowMeans(across(c("SPI.D3.16.INST",
                                            "SPI.D3.17.PTNS" ))),
         SPI.DIM4.1=rowMeans(across(starts_with('SPI.D4.1'))),
         SPI.DIM4.2=rowMeans(across(starts_with('SPI.D4.2'))),
         SPI.DIM4.3=rowMeans(across(starts_with('SPI.D4.3'))),
         #SPI.DIM5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.2=rowMeans(across(starts_with('SPI.D5.2'))),
         #SPI.DIM5.5=rowMeans(across(starts_with('SPI.D5.5')))
                 ) %>%
  mutate(
         SPI.INDEX.PIL1=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.INDEX.PIL2=rowMeans(across(starts_with("SPI.DIM2")), na.rm=FALSE),
         SPI.INDEX.PIL3.ALT=(6*SPI.DIM3.1 + 6*SPI.DIM3.2 + 2*SPI.DIM3.3 + 2*SPI.DIM3.4)/16,
         SPI.INDEX.PIL4=rowMeans(across(starts_with("SPI.DIM4")), na.rm=FALSE),
         SPI.INDEX.PIL5=rowMeans(across(starts_with("SPI.DIM5")), na.rm=FALSE),
         SPI.INDEX.ALT=rowMeans(across(c('SPI.INDEX.PIL1',
                                     'SPI.INDEX.PIL2',
                                     'SPI.INDEX.PIL3.ALT',
                                     'SPI.INDEX.PIL4',
                                     'SPI.INDEX.PIL5')), na.rm=FALSE)
         ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX.ALT) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX'), everything()) %>%
    filter(date>=2016) #2016 is first year with complete data


#################
# Nested Index with high income coutries top coded
################
  spi_index_df_dim3_alt2 <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  select(country, iso3c, date, everything()) %>%
  mutate(across(starts_with("SPI.D3"),
                ~if_else(( (income=='High income')  ),1,.)                )) 



#Create overall subscores corresponding to John's framework
  spi_index_df_dim3_alt2 <- spi_index_df_dim3_alt2 %>%
    mutate(SPI.DIM2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4=SPI.D2.4.NADA,
         SPI.DIM3.1=rowMeans(across(c("SPI.D3.1.POV",
                                            "SPI.D3.2.HNGR",
                                            "SPI.D3.3.HLTH",
                                            "SPI.D3.4.EDUC",
                                            "SPI.D3.5.GEND",
                                            "SPI.D3.6.WTRS"))),
         SPI.DIM3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                            "SPI.D3.8.WORK",
                                            "SPI.D3.9.INDY",
                                            "SPI.D3.10.NEQL",
                                            "SPI.D3.11.CITY",
                                            "SPI.D3.12.CNSP"))),         
         SPI.DIM3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                            "SPI.D3.15.LAND" ))),
         SPI.DIM3.4=rowMeans(across(c("SPI.D3.16.INST",
                                            "SPI.D3.17.PTNS" ))),
         SPI.DIM4.1=rowMeans(across(starts_with('SPI.D4.1'))),
         SPI.DIM4.2=rowMeans(across(starts_with('SPI.D4.2'))),
         SPI.DIM4.3=rowMeans(across(starts_with('SPI.D4.3'))),
         #SPI.DIM5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.2=rowMeans(across(starts_with('SPI.D5.2'))),
         #SPI.DIM5.5=rowMeans(across(starts_with('SPI.D5.5')))
                 ) %>%
  mutate(
         SPI.INDEX.PIL1=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.INDEX.PIL2=rowMeans(across(starts_with("SPI.DIM2")), na.rm=FALSE),
         SPI.INDEX.PIL3.ALT2=(6*SPI.DIM3.1 + 6*SPI.DIM3.2 + 2*SPI.DIM3.3 + 2*SPI.DIM3.4)/16,
         SPI.INDEX.PIL4=rowMeans(across(starts_with("SPI.DIM4")), na.rm=FALSE),
         SPI.INDEX.PIL5=rowMeans(across(starts_with("SPI.DIM5")), na.rm=FALSE),
         SPI.INDEX.ALT2=rowMeans(across(c('SPI.INDEX.PIL1',
                                     'SPI.INDEX.PIL2',
                                     'SPI.INDEX.PIL3.ALT2',
                                     'SPI.INDEX.PIL4',
                                     'SPI.INDEX.PIL5')), na.rm=FALSE)
         ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX.ALT2) %>%
  select(country, iso3c, date, SPI.INDEX.ALT2,SPI.INDEX.PIL3.ALT2, income) %>%
    mutate(weights=1) %>%
    filter(date>=2016) #2016 is first year with complete data
 
#merge the two indices and compare  
index_compare <- spi_index_df_dim3_alt %>%
  transmute(
    country=country,
    iso3c=iso3c,
    date=date,
    SPI.INDEX.ALT=SPI.INDEX.ALT
  ) %>%
  filter(date==end_date) %>%
  filter(!is.na(SPI.INDEX.ALT)) %>%
  left_join(select(spi_index_df, country, date, SPI.INDEX) ) %>%
  left_join(spi_index_df_dim3_alt2) %>%
  select(-SPI.INDEX.PIL3.ALT2,-income)

    spi_groups_quantiles <- quantile(index_compare$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
    spi_alt_groups_quantiles <- quantile(index_compare$SPI.INDEX.ALT, probs=c(1,2,3,4)/5,na.rm=T)
    spi_alt2_groups_quantiles <- quantile(index_compare$SPI.INDEX.ALT2, probs=c(1,2,3,4)/5,na.rm=T)

    index_compare <- index_compare %>%
      mutate(spi_groups=case_when(
        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_groups=factor(spi_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  %>%
      mutate(spi_alt_groups=case_when(
        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[3],spi_alt_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[2],spi_alt_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX.ALT, spi_alt_groups_quantiles[1],spi_alt_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX.ALT, 0,spi_alt_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_alt_groups=factor(spi_alt_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" ))) %>%
      mutate(spi_alt2_groups=case_when(
        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[3],spi_alt2_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[2],spi_alt2_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX.ALT2, spi_alt2_groups_quantiles[1],spi_alt2_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX.ALT2, 0,spi_alt2_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_alt2_groups=factor(spi_alt2_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" ))) %>%
      mutate(weights=1)


```

```{r index_compare_plot, eval=FALSE, include=FALSE}


spi_charts('spi_index_df_dim3_alt', 'SPI.INDEX.PIL3.ALT','Pillar 3: Data Products - OECD High Income Top Coded')


```

```{r index_compare_plot2, eval=FALSE, include=FALSE}


spi_charts('spi_index_df_dim3_alt2', 'SPI.INDEX.PIL3.ALT2','Pillar 3: Data Products - All High Income Top Coded')


```

### Pillar 4: Data Sources

Pillar 4 examines whether countries have the data sources available that are necessary to produce statistics for public use. It includes three aspects of data sources: censuses and surveys, administrative data, and geospatial data. Private and citizen generated data is an important area that is at present not incorporated due to the lack of an established source. For censuses and surveys  the score reflects both whether a data source exists and how recently the source was produced, as both are needed for accurate reporting of current conditions. For administrative data and geospatial data,  proxies regarding the state of these data systems are used.


*Figure 6.10: Pillar 4: Data Sources Scores by Quintile in `r end_date`*
```{r pillarsplot4}
spi_mapper('spi_index_df','SPI.INDEX.PIL4','Pillar 4: Data Sources Scores')
```


When looking at the country chart, again there is significant variability across countries.  No country receives the maximum score of 100, with many countries falling short particularly on our geospatial indicator.  Somalia is the only country that receives a score of 0.

*Figure 6.11: Pillar 4: Data Sources Scores by Country and Region in `r end_date`*
```{r countrypillarsplot4}

spi_country_charts('spi_index_df','SPI.INDEX.PIL4','Pillar 4: Data Sources Scores')



```


```{r maturitytable4}

indicators<-c("SPI.INDEX.PIL4",
              "SPI.D4.1.1.POPU",
              "SPI.D4.1.2.AGRI",
              "SPI.D4.1.3.BIZZ",
              "SPI.D4.1.4.HOUS",
              "SPI.D4.1.5.AGSVY",
              "SPI.D4.1.6.LABR",
              "SPI.D4.1.7.HLTH",
              "SPI.D4.1.8.BZSVY",
              "SPI.D4.2.3.CRVS",
              "SPI.D4.3.GEO.first.admin.level")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])

pop_top <- as.numeric(maturity_tab[2,2])
pop_bottom <- as.numeric(maturity_tab[2,6])
pop_gap <- pop_top-pop_bottom

business_gap <- as.numeric(maturity_tab[9,2])-as.numeric(maturity_tab[9,6])

geo_top <- as.numeric(maturity_tab[11,2])
geo_bottom <- as.numeric(maturity_tab[11,6])


```


Countries in the top 20% have an average score of `r spi_top`, while countries in the bottom 20% have an average score of `r spi_bottom`.  The gap between the top 20% and bottom 20% for the population and housing census indicator is `r pop_gap` points on a scale from 0 to 1.  The gap for countries conducting a business/establishment survey is `r business_gap`.  The scores on the geospatial indicator are low.  The average score for the top 20%  is `r geo_top`, while it is `r geo_bottom` for the bottom 20%.

*Table 6.6: Select Pillar 4 Indicator Scores by SPI Overall Score Quintile Group in `r end_date`*
```{r maturitdisp4}

maturity_tab <- maturity_tab %>%
  flextable() 
  # add_header_lines('Select SPI Indicator Scores by SPI Pillar 4 Quintile Group') 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```

### Pillar 5: Data Infrastructure

The fifth pillar measures whether countries have the hard and soft infrastructure to produce the data sources, data products, and data services to produce useful data. For the pillar 5 sub-score, the only usable data is on  a set of ten methods, standards, and classifications.   Internationally accepted and recommended methodology, classifications and standards provide the basis for national statistical offices (NSOs) on data integration, facilitating data exchange and providing the foundation for the preparation of relevant statistical indicators.  The following methods and standards are considered:  System of national accounts in use, National Accounts base year, Classification of national industry, CPI base year, Classification of household consumption, Classification of status of employment, Central government accounting status, Compilation of government finance statistics, Compilation of monetary and financial statistics, and Business process. Data has also been collected on statistical legislation and governance, as well as on finance, but these indicators currently lack adequate country coverage to include in the index.  


```{r maturitytable5}

indicators<-c("SPI.INDEX.PIL5",
              #"SPI.D5.1.DILG",
              "SPI.D5.2.1.SNAU",
              "SPI.D5.2.2.NABY",
              "SPI.D5.2.3.CNIN",
              "SPI.D5.2.4.CPIBY",
              "SPI.D5.2.5.HOUS",
              "SPI.D5.2.6.EMPL",
              "SPI.D5.2.7.CGOV",
              "SPI.D5.2.8.FINA",
              "SPI.D5.2.9.MONY",
              "SPI.D5.2.10.GSBP")
              #"SPI.D5.5.DIFI")

maturity_tab <- spi_maturity_table('spi_index_df',indicators,end_date) 

spi_top <- as.numeric(maturity_tab[1,2])
spi_bottom <- as.numeric(maturity_tab[1,6])



```

Countries scoring in the top 20% tend to be concentrated among the high income countries.  These top scoring countries have an average score for pillar 5 of `r spi_top`, which is near the maximum score of 100.  Countries in the bottom 20% have an average score fo `r spi_bottom`.

*Figure 6.12: Pillar 5: Data Infrastructure Scores by Quintile in `r end_date`*
```{r pillarsplot5}
spi_mapper('spi_index_df','SPI.INDEX.PIL5','Pillar 5: Data Infrastructure Scores')

```

Several countries score the maximum of 100 in the data infrastructure pillar  One country, Somalia, scores 0 points in this pillar.  

*Figure 6.13: Pillar 5: Data Infrastructure Scores by Country and Region in `r end_date`*
```{r countrypillarsplot5}

spi_country_charts('spi_index_df','SPI.INDEX.PIL5','Pillar 5: Data Infrastructure Scores')



```



Among countries in the top 20%, the average score is near 100 across all the indicators of pillar 5. In the bottom 20%, countries on average score close to zero points for the CPI base year, classification of status of employment, central government accounting status, compilation of government finance statistics, and business process indicators. Bottom 20% countries, score above 0.5 points on the system of national accounts in use and compilation of monetary and financial statistics indicators.

*Table 6.8: Select Pillar 5 Indicator Scores by SPI Overall Score Quintile Group in `r end_date`*
```{r maturitdisp5}

maturity_tab <- maturity_tab %>%
  flextable() 
  # add_header_lines('Select SPI Indicator Scores by SPI Pillar 5 Quintile Group') 

FitFlextableToPage(maturity_tab) %>%
  align( align = "left", part = "body")

```

### Correlations between SPI pillars

In the following chart, correlations between the SPI overall score and the individual SPI pillar scores are shown. All pillars are positively correlated with one another. At the same time, no dimension is perfectly correlated with any of the other dimensions, which would indicate that a dimension was not providing any additional information on the statistical performance of countries. The pillar with the single highest correlation with the overall measure is pillar 1 on data use; pillar 3 on data products has the lowest overall correlation. 

*Figure 6.14: Correlation Between SPI pillars in `r end_date`*
```{r dimcorr, echo=FALSE}

corr_df <- spi_index_df %>%
  ungroup() %>%
  select(starts_with('SPI.INDEX'))

#calculate correlations between teacher practices
df_corr_plot <-    round(cor(corr_df, use="complete.obs"), 2) 
colnames(df_corr_plot) <- c('Data Use','Data Services','Data Products','Data Sources','Data Infrastructure','SPI Overall')
rownames(df_corr_plot) <- c('Data Use','Data Services','Data Products','Data Sources','Data Infrastructure','SPI Overall')

#plot the correlation in a nicely formatted table
pcorr<- ggcorrplot::ggcorrplot(df_corr_plot,
                   outline.color = "white",
                   ggtheme = theme_spi(),
                   colors = c("#F8696B", "#FFEB84", "#63BE7B"),
                   legend.title = "Correlation",
                   title = "Correlation Between SPI pillars",
                   lab=T) + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 16)) +
  theme_spi() +
  theme(
    text = element_text(size = 12),
    axis.text.x = element_text(angle=45,vjust=.5)
  ) +
  labs( )

pcorr

```

## SPI Scores by Dimension and Indicator

While there are large differences across regions, income groups, and countries in the SPI overall score, there are also differences across indicators in the strengths and weaknesses of countries that have the same final score. For instance, some countries may reach a final score by excelling in the area of data sources, while others may reach a final score by excelling in data infrastructure. There are many paths that countries may take to reach an SPI overall score and only by studying the pillars and indicators for a particular country in detail can you understand why a country gets a particular score. To help interpret the scores, it is possible to analyze which of the pillars and indicators are most responsible for differences between countries.

In order to do so,  a leave-out approach to calculating the SPI overall scores has been taken, which can help to understand which pillars and indicators are most impactful. The leave-out approach is similar in spirit to a jackknife approach (see [@miller1974jackknife] for an introduction), which has been used in a variety of situations to examine the sensitivity of estimates to leaving out specific observations. Specifically for this case, the leave-out approach consists of sequentially deleting indicators one at a time and recalculating the SPI overall scores. By sequentially omitting indicators, the total difference between the SPI overall score incorporating all indicators and an alternative SPI score that is calculated by omitting a single indicator can be computed.The pillars and indicators can then be ranked, based on which produce the greatest total difference between the SPI overall score and the alternative score.

Specifically, the approach is as follows:   

1. Calculate the SPI overall score for each country using all dimensions and indicators, $SPI.INDEX_{c}$.    
  
2. For each indicator $j=1,...,J$ do:   
  
  + Generate an alternative SPI score omitting indicator $j$, $SPI.INDEX^{-j}_{c}$.    
    
  + Calculate difference between the original score and the alternative score for each country in a year $t$, $e_{c}^{-j}=SPI.INDEX_{c}-SPI.INDEX^{-j}_{c}$ 
    
  + Calculate the mean absolute difference across all countries, $E^{-j}=\sum_{c=1}^{N_c} |e_{c}^{-j}|/C$ 
    
3. Sort indicators based on $E^{-j}$.


```{r leave_out, include=FALSE, cache=TRUE}

leave_out_fun <-  function(variables) {
  
spi_index_df_alt <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  mutate(across(starts_with(variables),~as.numeric(NA))) %>% #convert selected variable to missing values then begin calculation without them
  select(country, iso3c, date, everything())



#Create overall subscores corresponding to John's framework
spi_index_df_alt <- spi_index_df_alt %>%
  mutate(SPI.DIM2.1=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4=SPI.D2.4.NADA,
         SPI.DIM3.1=rowMeans(across(c("SPI.D3.1.POV",
                                          "SPI.D3.2.HNGR",
                                          "SPI.D3.3.HLTH",
                                          "SPI.D3.4.EDUC",
                                          "SPI.D3.5.GEND",
                                          "SPI.D3.6.WTRS")), na.rm=TRUE),
         SPI.DIM3.2=rowMeans(across(c("SPI.D3.7.ENRG",
                                          "SPI.D3.8.WORK",
                                          "SPI.D3.9.INDY",
                                          "SPI.D3.10.NEQL",
                                          "SPI.D3.11.CITY",
                                          "SPI.D3.12.CNSP")), na.rm=TRUE),         
         SPI.DIM3.3=rowMeans(across(c("SPI.D3.13.CLMT",
                                          "SPI.D3.15.LAND" )), na.rm=TRUE),
         SPI.DIM3.4=rowMeans(across(c("SPI.D3.16.INST",
                                          "SPI.D3.17.PTNS" )), na.rm=TRUE),
         SPI.DIM4.1=rowMeans(across(starts_with('SPI.D4.1')), na.rm=TRUE),
         SPI.DIM4.2=rowMeans(across(starts_with('SPI.D4.2')), na.rm=TRUE),
         SPI.DIM4.3=rowMeans(across(starts_with('SPI.D4.3')), na.rm=TRUE),
         #SPI.DIM5.1=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.2=rowMeans(across(starts_with('SPI.D5.2')), na.rm=TRUE),
         #SPI.DIM5.5=rowMeans(across(starts_with('SPI.D5.5')))
  ) %>%
  mutate(
    SPI.INDEX.PIL1=rowMeans(across(starts_with("SPI.D1.5")), na.rm=TRUE),
    SPI.INDEX.PIL2=rowMeans(across(starts_with("SPI.DIM2")), na.rm=TRUE),
    SPI.INDEX.PIL3=(6*SPI.DIM3.1 + 6*SPI.DIM3.2 + 2*SPI.DIM3.3 + 2*SPI.DIM3.4)/16,
    SPI.INDEX.PIL4=rowMeans(across(starts_with("SPI.DIM4")), na.rm=TRUE),
    SPI.INDEX.PIL5=rowMeans(across(starts_with("SPI.DIM5")), na.rm=TRUE),
    SPI.INDEX.ALT=rowMeans(across(c('SPI.INDEX.PIL1',
                                    'SPI.INDEX.PIL2',
                                    'SPI.INDEX.PIL3',
                                    'SPI.INDEX.PIL4',
                                    'SPI.INDEX.PIL5')), na.rm=TRUE)
  ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX.ALT) %>%
  select(country, iso3c, date, SPI.INDEX.ALT) %>%
  filter(date>=2016) #2016 is first year with complete data

  #form database with both measures
  spi_index_df %>%
    select(country, iso3c, date, SPI.INDEX) %>%
    left_join(spi_index_df_alt) %>%
    ungroup() %>%
    summarise(mean_abs_diff=mean(abs(SPI.INDEX-SPI.INDEX.ALT), na.rm=T))

  
}

leave_out_df <- metadata_full %>%
  filter(!grepl('SPI.INDEX|RAW.',source_id)) %>%
  nest(source_id) %>%
  mutate(
    ABS.DIFF=map(
      data,
      ~leave_out_fun(.x$source_id)
    )
  ) %>%
  unnest(ABS.DIFF)


```

*Figure 6.15: SPI Indicator Importance for Top 10 and Bottom 10 Indicators in `r end_date`*

```{r leaveoutplot, fig.height=9}

leave_out_plot_df <- leave_out_df %>%
  mutate(source_name=gsub("\\(5 year moving average\\)","", source_name),
         descript=str_wrap(paste(SPI_indicator_id,": ", source_name , sep=""),50)
         ) %>%
  filter(mean_abs_diff>0) %>%
  arrange(mean_abs_diff) %>%
  mutate(descript=factor(descript, levels=descript))

#get top 10 and bottom 10 
leave_out_plot_df_trunc <- leave_out_plot_df %>%
  head(10) %>%
  mutate(group='Bottom 10') %>%
  bind_rows(leave_out_plot_df %>% tail(10) %>% mutate(group='Top 10')) %>%
  arrange(mean_abs_diff)


  ggplot(leave_out_plot_df_trunc, aes(x=descript, y=mean_abs_diff, color=group)) +
    geom_segment( aes(x=descript ,xend=descript, y=0, yend=mean_abs_diff)) +
    geom_point(size=3) +
    geom_text(aes(label=round(mean_abs_diff,2)),color='black', nudge_y=.2) +
    coord_flip() +
    theme_spi() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.position = 'top'
    ) +
    xlab("") +
    ylab("Mean Absolute Difference") +
    labs(
      title="SPI Indicator Importance for Top 10 and Bottom 10 Indicators",
      subtitle = "Mean absolute difference in SPI overall scores leaving out indicator",
      caption=str_wrap("The leave-out approach consists of sequentially deleting dimensions or indicators one at a time and recalculating the SPI overall scores.",80)
    )

```

The indicator that drives the single largest difference between the SPI overall score and an alternative score omitting the indicator is the NADA metadata availability indicator in dimension 2.4 on data access services.  This is closely followed by the indicator on whether geospatial information is available and whether a complete civil registration and vital statistics system (CRVS) is available.  The indicators creating the smallest difference when omitted tend to the be the individual indicators in pillar 3 on data products.  The indicator with the single smallest difference is in Pillar 3:4 on SDG 4


```{r anova, eval=FALSE, include=FALSE}

#Analysis of variance.  In the analysis below, I will calculate the variance in each pillar and in each dimension.

anova_pil_df <- spi_index_df %>%
  select(country, iso3c, date, starts_with("SPI.INDEX")) %>%
  pivot_longer(
    cols=starts_with("SPI.INDEX"),
    names_to='Pillar',
    values_to='value'
  ) %>%
  group_by(Pillar, date) %>%
  nest() %>%
  mutate(
    std_dev=map(
      data,
      ~round(sd(.x$value, na.rm=T),2),
                ),
    std_dev=as.numeric(std_dev)
  ) %>%
  left_join(metadata_full, by = c('Pillar'='source_id'))
  

anova_pil_plot <- anova_pil_df %>%
  filter(date==end_date) %>%
  ggplot(aes(x=source_name, y=std_dev))  +
  geom_segment( aes(x=source_name ,xend=source_name, y=0, yend=std_dev), color="black") +
  geom_point(size=3) +
  # scale_color_manual(name="HCI",
  #                    labels = c("Over-performers", "Under-performers"),
  #                    values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("Standard Deviation") +
  ggtitle("Variation in SPI Pillars")

anova_pil_plot

```

```{r anova2, eval=FALSE, include=FALSE}

#Analysis of variance.  In the analysis below, I will calculate the variance in each dimension and in each dimension.

anova_pillar_df <- spi_index_df %>%
  mutate(SPI.DIM1.5=SPI.INDEX.PIL1/100) %>%
  select(country, iso3c, date, starts_with("INDEX")) %>%
  pivot_longer(
    cols=starts_with("INDEX"),
    names_to='Dimension',
    values_to='value'
  ) %>%
  group_by(Dimension, date) %>%
  nest() %>%
  mutate(
    std_dev=map(
      data,
      ~round(sd(.x$value, na.rm=T),2)
        ),
    std_dev=as.numeric(std_dev)
  ) %>%
  left_join(pillars, by = c('Dimension'='dimension_id'))
  
    
anova_pillar_plot <- anova_pillar_df %>%
  filter(date==end_date) %>%
  ggplot(aes(x=Dimension, y=std_dev))  +
  geom_segment( aes(x=Dimension ,xend=Dimension, y=0, yend=std_dev), color="black") +
  geom_point(size=3) +
  # scale_color_manual(name="HCI",
  #                    labels = c("Over-performers", "Under-performers"),
  #                    values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("Standard Deviation") +
  ggtitle("Variation in SPI Dimensions")

anova_pillar_plot  

```


# Analysis

## Unique Values

```{r unique_scores}

#calculate the number of unique values in the SPI Index
spi_index_end_date <- spi_index_df %>%
  filter(date==end_date) %>%
  filter(!is.na(SPI.INDEX))

unique_scores <-  length(unique(spi_index_end_date$SPI.INDEX))

#check unique values by pillar.
unique_scores1 <-  length(unique(spi_index_end_date$SPI.INDEX.PIL1))
unique_scores2 <-  length(unique(spi_index_end_date$SPI.INDEX.PIL2))
unique_scores3 <-  length(unique(spi_index_end_date$SPI.INDEX.PIL3))
unique_scores4 <-  length(unique(spi_index_end_date$SPI.INDEX.PIL4))
unique_scores5 <-  length(unique(spi_index_end_date$SPI.INDEX.PIL5))

```


As a check of the data, the number of unique scores for the SPI overall score is calculated. If the SPI overall score produces a large number of tied scores, for instance, then the index will be less able to distinguish between the statistical performance of countries.  When calculating the number of unique values for `r end_date`, it is found that there are `r unique_scores` unique scores for `r n_countries` countries.  This means there are `r n_countries-unique_scores` tied values.    

When looking at each specific pillar, there are only `r unique_scores1` unique scores for pillar on data use.  The data use indicator is coming solely from dimension 1.5 on data use by international organizations.  For pillar, there are `r unique_scores2` unique scores.  For pillar 3, there are `r unique_scores3` unique scores.  There are `r unique_scores4` unique scores for pillar 4, and there are `r unique_scores5` unique scores for pillar 5.




## Relationship to GDP Per Capita and the Human Capital Index

The correlation between the SPI overall score and and the log of GDP per capita and the World Bank’s Human Capital Index ((Bank 2020)) provide a face validity check between the SPI index and other outcomes. This analysis is not meant to assert a causal relationship, only to assess whether the SPI index is correlated with other outcomes in ways that might be expected. The source for GDP per capita comes from the World Bank’s World Development Indicators (WDI) database (NY.GDP.PCAP.KD). The GDP per capita numbers are in constant 2010 US$.



```{r log_gdp}

#HCI
hci_df <- wbstats::wb_data(country="countries_only", 
              indicator='HD.HCI.OVRL',
              start_date=2016,
              end_date=2020,
              return_wide = F) %>%
  left_join(select(spi_index_df,iso3c,date, region,starts_with('SPI.INDEX'))) #merge on SPI Index data

#get the correlation for 2020
hci_df_2018 <- hci_df %>%
  filter(date==2020) 




hci_spi <- ggplot(data=hci_df_2018, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_spi() +
  ylab('SPI Overall Score') +
  xlab('Human Capital Index') +
  geom_richtext(
    aes(x = 0.5, y = 20,label = eq_plot_txt(hci_df_2018)), hjust=0.2
  ) 


#GDP
gdp_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2022,
  return_wide = F
    ) %>%
  left_join(select(spi_index_df,iso3c,date, region,starts_with('SPI.INDEX'))) #merge on SPI Index data

#get the correlation for 2020
gdp_df_2020 <- gdp_df %>%
  filter(date==2022) 

#text for plot
eq <- lm_robust(SPI.INDEX ~ log(value), data=gdp_df_2020 , se_type='HC2')
coef <- coef(eq)
std_err <- sqrt(diag(vcov(eq)))
r_2<- summary(eq)$r.squared
plot_txt <- sprintf("y = %.3f + %.3f ln(x), R^2 = %.3f<br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

  gdp_spi <- ggplot(data=gdp_df_2020, aes(x=value, y=SPI.INDEX)) +
  facet_wrap(~indicator) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  scale_x_log10(labels = scales::comma) +
  theme_spi() +
  ylab('SPI Overall Score') +
  xlab('Log GDP Per Capita') +
  theme(legend.position = 'bottom') +
  geom_richtext(
    aes(x = 1000, y = 20,label = plot_txt), hjust=0.2
  )   

  




corr_hci_2018 <- cor(hci_df_2018$value,hci_df_2018$SPI.INDEX, use='pairwise.complete.obs')


corr_2020 <- cor(log(gdp_df_2020$value),gdp_df_2020$SPI.INDEX, use='pairwise.complete.obs')
corr_2020_nontrans <- cor(gdp_df_2020$value,gdp_df_2020$SPI.INDEX, use='pairwise.complete.obs')

```
It would be expected that a strong positive relationship between GDP per capita of countries and their statistical system, as higher income countries would tend to have more resources available for statistical production.  In fact, there is a strong relationship between the two.  The correlation in 2022 between log GDP per capita and the SPI overall score is `r round(corr_2020,2)`.[^1]

[^1]: To understand what effect taking the log has on this correlation, the correlation in 2022 between (non-logged) GDP per capita and the SPI overall score is `r round(corr_2020_nontrans,2)`. 

Another measure of a country's development is the Human Capital Index (HCI) developed by the World Bank ([@hci2019]).  The Human Capital Index is designed to capture the amount of human capital a child born today can expect to attain by age 18 in a country.  The index combines a country's child mortality, learning adjusted years of schooling, adult survival rates & stunting into one index.^[For more details, visit the [Human Capital Index website](https://www.worldbank.org/en/publication/human-capital)].  Again,  a strong positive relationship between a country's HCI value and their Statistical Performance Indicators index might  be expected, as countries with a more developed human capital stock are likely to have greater capacity to produce statistics.  Again, this is what is seen.  The correlation between the 2020 value of the HCI and the 2020 value of the SPI overall score is `r round(corr_hci_2018,2)`.

The scatter plot of the relationship between log GDP per capita, the HCI, and our SPI overall score for the years 2016-2020 is shown below.  In general, countries with higher per capita income and higher levels of human capital tend to have better performing statistical systems according to the SPI measure.  

*Figure 7.1: Plot of SPI overall score on Human Capital Index and GDP per capita*
```{r gdpplot}

### Scatterplot log GDP SPI
gdp_spi + hci_spi   +
  plot_annotation(
    # title='Plot of SPI overall score on Human Capital Index and GDP per capita',
    caption='Source: All indicators come from the World Bank.'
    ) +
  theme_spi()
  

```

So as to highlight countries where this relationships do not hold as well, the next figure shows the 15 countries that most over-perform and the 15 countries that most under-perform on the SPI Index compared to their levels of GDP per capita and the Human Capital Index. A perfect fit between the SPI overall score and GDP per capita and the Human Capital Index is not to be expected, as countries differ in the resources put into their statistical system, even conditional on their levels of development. Highlighting outliers can sometimes be a useful exercise for determining whether a measure is identifying on the ground realities.

In order to produce this figure, an OLS regression of the SPI overall score in 2020 on log GDP per capita has been estimated.The residual, which can be interpreted as the difference between the country’s SPI overall score value and the expected index value based on their GDP per capita has then been calculated. Countries with values of the residual greater than zero are over-performing based on their GDP per capita and countries with residuals less than zero are under-performing. The corresponding figure for the Human Capital Index is calculated similarly.

This figure identifies some countries that appear to have better performing statistical systems than might be expected (Rwanda, Uganda, Egypt, Mexico, Philippines, Armenia and Turkey appear in green on both charts). There are also countries that appear to have poorer performing statistical systems than expected: there are several small island states for example that appear red on both charts.

*Figure 7.2: Top 15 Over/Under-Performers on SPI overall score compared to GDP per capita in 2022 and Human Capital Index in 2020* 
```{r overperformers}

#get top 10 and bottom 10 over performers compared to gdp and hci

## GDP
#regress SPI on gdp

indicator <- 'SPI.INDEX'

form <- paste(indicator, " ~ log(value)", sep="")

m_spi <- lm(form , data = gdp_df_2020) 

gdp_overperformers_df <- gdp_df_2020 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(-resid) %>%
  head(15)

gdp_underperformers_df <- gdp_df_2020 %>%
  modelr::add_residuals(m_spi) %>%
  arrange(resid) %>%
  head(15)


gdp_overperformers_plot <-  gdp_overperformers_df %>%
  bind_rows(gdp_underperformers_df) %>%
  arrange(resid) 

gdp_overperformers_plot <- gdp_overperformers_plot %>%
  mutate(country=factor(country, levels=unique(gdp_overperformers_plot$country)),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="GDP per Capita",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("GDP per capita")



### HCI


#regress SPI on hci
m_spi_hci <- lm(form , data = hci_df_2018) 

hci_overperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(-resid) %>%
  head(15)

hci_underperformers_df <- hci_df_2018 %>%
  modelr::add_residuals(m_spi_hci) %>%
  arrange(resid) %>%
  head(15)

hci_overperformers_plot <-  hci_overperformers_df %>%
  bind_rows(hci_underperformers_df) %>%
  arrange(resid) 

hci_overperformers_plot <- hci_overperformers_plot %>%
  mutate(country=factor(country, levels=unique(hci_overperformers_plot$country)),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="HCI",
                     labels = c("Over-performers", "Under-performers"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_spi() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("SPI (deviation)") +
  ggtitle("Human Capital Index")



gdp_overperformers_plot + hci_overperformers_plot +
  plot_annotation(
    # title='Top 15 Over/Under-Performers on SPI overall score compared to GDP per capita and Human Capital Index',
                  caption=str_wrap('Over and under performers calculated for GDP per capita by using OLS regression of SPI overall score in 2022 on Log GDP per capita and calculting residuals from this regression.  Over and Under performers for Human Capital Index calculated similarly.',100)
                  )
```


## Relationship to Government Effectiveness

```{r ge}

#HCI
ge_df <- wbstats::wb_data(country="countries_only", 
              indicator=c('GE.EST','NY.GDP.PCAP.KD', 'GE.PER.RNK'),
              start_date=2016,
              end_date=2022,
              return_wide = T) %>%
  left_join(select(spi_index_df,iso3c,date, region,starts_with('SPI.INDEX'))) #merge on SPI Index data

#get the correlation for 2020
ge_df_2020 <- ge_df %>%
  filter(date==2022) 


corr_ge <- cor(ge_df_2020$GE.EST,ge_df_2020$SPI.INDEX, use='pairwise.complete.obs')



ge_spi <- lm_robust(GE.EST ~ SPI.INDEX + log(NY.GDP.PCAP.KD) + factor(date) + factor(region) , data = ge_df, se_type = "HC2") 

ge_spi_tidy <- broom::tidy(ge_spi)
ge_spi_glance <- broom::glance(ge_spi)

#get effect of SPI
spi_eff <- ge_spi_tidy %>%
  filter(term=='SPI.INDEX')
spi_eff <- spi_eff$estimate
```


A common justification for improving statistical systems is that doing so can lead to better governance. Without good statistics, countries may be flying blind on where to target resources to improve the public welfare.  Also, good statistics can help hold public officials accountable for progress toward reaching a country's goals. In this next section, it is shown that the relationship between our SPI overall score and an estimate of government effectiveness produced by the Worldwide Governance Indicators (WGI)  is analyzed.  A strong relationship between the SPI measure of statistical performance and the WGI measure of governmental effectiveness is found.

[@kraay2010worldwide] produce a set of Worldwide Governance Indicators, including a measure of government effectiveness.  According to the WGI metadata, the government effectiveness indicator captures perceptions of the quality of public services, the quality of the civil service and the degree of its independence from political pressures, the quality of policy formulation and implementation, and the credibility of the government's commitment to such policies. The estimate gives the country's score on the aggregate indicator, in units of a standard normal distribution, i.e. ranging from approximately -2.5 to 2.5.^[Detailed documentation of the WGI, interactive tools for exploring the data, and full access to the underlying source data available at www.govindicators.org. The WGI are produced by Daniel Kaufmann (Natural Resource Governance Institute and Brookings Institution) and Aart Kraay (World Bank Development Research Group).].  The government effectiveness indicator is available from 1996 to 2022.

There is a strong relationship between the SPI overall score and the government effectiveness indicator.  The correlation between the two in 2022 is `r round(corr_ge,2)`.  The scatterplot below shows the relationship between the SPI overall score and the government effectiveness indicator.




*Figure 7.3: Plot of SPI overall score on Government Effectiveness in 2022*
```{r geplot}

ge_df_2020 <- ge_df_2020 %>%
  rename(value=GE.EST)

ge_spi_plot <- ggplot(data=ge_df_2020, aes(x=value, y=SPI.INDEX)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm') +
  theme_spi() +
  ylab('SPI Overall Score') +
  xlab('Government Effectiveness Score (z score)') +
  geom_richtext(
    aes(x = 0.5, y = 5,label = eq_plot_txt(ge_df_2020), hjust=0.2)
  ) +  
    theme(legend.position = 'bottom') +
  labs(
    title='Plot of SPI overall score on Government Effectiveness',
    caption='Source: All indicators come from the World Bank.  Government Effectiveness indicator comes from Worldwide Governance Indicators.'
  )


ge_spi_plot

```


To tease out to what extent the relationship between the government effectiveness indicator and the SPI is due to other factors such as income or regional characteristics, the results from an OLS regression are presented below.  While it is acknowledged that a more detailed study could be conducted to better understand the processes relating the two, a relationship is found between government effectiveness and statistical performance after accounting for income and regional characteristics of a country.

The regression model used takes the following form:

$$ G_{ctr} = \alpha_t + \gamma_r + \beta SPI.INDEX_{ctr} + \theta X_{ctr} + \epsilon_{ctr} $$

where $Y_{ctri}$ is the government effectiveness estimate for country i, in time period t, and region r.  $SPI.INDEX_{ctri}$ is the SPI overall score. $X_{ctri}$ is a set of control variables in the regression. This includes log GDP per capita from the World Bank WDI. $\epsilon_{ctri}$ is the error term.  $\alpha_t$ is an indicator variable for each year and  $\gamma_r$ is a regional indicator variable.

The table below shows the estimate of $\beta$, the effect of the statistical performance measure on government effectiveness.  Full results from this regression are shown in a table in the appendix.  The estimated coefficient is statistically significant at the 0.1% level, and implies that a 10 point increase in the SPI overall score is associated with a `r round(10*spi_eff,2)` standard deviation increase in government effectiveness.  For context, this 10 point jump in the SPI would roughly take a country from roughly the median in terms of government effectiveness to roughly the 58th percentile.



*Table 7.1: Linear Regressions of Government Effectiveness Score on SPI Overall Score from 2016-19*
```{r geregsmall, echo=FALSE}
# 





#fix labels
factor_names <- grep("factor", names(coef(ge_spi)), value = TRUE)
names(factor_names) <- gsub(".*)(.)", "\\1", factor_names)


#create table
huxtable::huxreg('Government Effectiveness'=ge_spi,
       coefs=c('SPI Overall Score'='SPI.INDEX'),
       note='{stars}. \nRegression also includes log GDP per capita, year indicator variables, and region indicator variables as controls.  \n Heteroskedasticity robust standard errors in parenthesis.',
       number_format=3,
       bold_signif=0.05) %>%
  #huxtable::set_caption('Linear Regressions of Changes in Government Effectiveness on Changes in SPI from 2016-19') %>%
  huxtable::as_flextable() %>%
  # add_header_lines('Linear Regressions of Government Effectiveness Score on SPI Overall Score from 2016-19') %>%
  FitFlextableToPage() %>%
  width(width = 2.5)

```

## Country Changes in the Index



```{r changes}
#create a dataframe for the 2016 SPI to calculate changes since 2016
spi_index_2016 <- spi_index_df %>%
  filter(date==2016) %>%
  filter(!is.na(SPI.INDEX)) %>%
  mutate(SPI.INDEX.2016=SPI.INDEX) %>%
  select(iso3c, country, region, SPI.INDEX.2016)

spi_changes <- spi_index_end_date %>%
  mutate(SPI.INDEX.end_date=SPI.INDEX) %>%
  select(iso3c, country,region, SPI.INDEX.end_date) %>%
  left_join(spi_index_2016)


#correlation
corr_end_date_2016 <- cor(spi_changes$SPI.INDEX.end_date,spi_changes$SPI.INDEX.2016, use='pairwise.complete.obs')


```

In order to assess how stable the index values are over time, comparisons have been made between the index values in 2016 and the `r end_date` values. Overall, the SPI overall score is quite stable over time. The correlation between the 2016 value and the `r end_date` value is `r round(corr_end_date_2016,2)`.

*Figure 7.4: Scatterplot of `r end_date` SPI overall score  & 2016 SPI overall score*
```{r changesplot}

ggplot(spi_changes, aes(x=SPI.INDEX.2016, y=SPI.INDEX.end_date, color=region)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  geom_segment(aes(x=10,xend=100, y=10,yend=100), color='grey') +
  expand_limits(x=c(10,100),y=c(10,100)) +
  theme_spi() +
  labs(
    title=paste0('Scatterplot of ',end_date,' SPI overall score  & 2016 SPI overall score'),
    caption = 'Solid grey line represents the 45 degree line.  Blue line represents line of best fit (regression line) with a 95% confidence interval shown in a shaded line.'
  ) +
  ylab(paste0(end_date,' SPI Overall Score')) +
  xlab('2016 SPI Overall Score') +
  theme(legend.position = 'bottom') +
    stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='blue',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = y~x, parse = TRUE, size = 4) +
  guides(
    size="none"
  )


```


```{r top_bottom_changes}

top_changes <- spi_changes %>%
  mutate(changes=SPI.INDEX.end_date-SPI.INDEX.2016) %>%
  arrange(-abs(changes)) %>%
  select(country,SPI.INDEX.end_date,SPI.INDEX.2016, changes) %>%
  mutate(across(c('SPI.INDEX.end_date','SPI.INDEX.2016', 'changes'),round,1))

top_mover <- as.character(top_changes[1,1])
top_mover_change <- as.numeric(top_changes[1,4])
```


While the scores were relatively stable over time, some countries did see large improvements in their score from 2016-`r end_date`. The country that improved most on the index from 2016 to `r end_date` was `r top_mover`. `r top_mover` improved by `r top_mover_change` points out of 100. The table below shows the changes in the SPI overall score for the top 10 largest improvers.


*Table 7.2: Top 10 Countries with Largest Changes from 2016-`r end_date`.*
```{r topbottomchangestab}
top_changes_tab <- flextable(head(top_changes,10)) %>%
  # add_header_lines('Top 10 Countries with Largest Changes from 2016-end_date.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.end_date=paste0("SPI Overall Score ", end_date),
                       SPI.INDEX.2016="SPI Overall Score 2016",
                       changes="Difference"
                                   )) 

FitFlextableToPage(top_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```



## Density Plots

As another check, the distribution of scores across countries for each year has been presented and compared to a normal distribution. This exercise checks for whether the distribution of the SPI overall scores contains significant skew or fat tails. There is some indication of a bunching of scores near the top of the distribution of SPI scores. This is due to a large number of OECD countries possessing similar scores. This is not unexpected as OECD requires member countries to adhere to several methodological standards and to regularly report on a large set of indicators. These countries also are composed of several of the highest income countries that tend to be on the frontier of statistical production.


```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- GET(url = paste0("http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2020&per_page=5000"))
Response_metadata <- content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
  left_join(spi_df_empty) %>% #add on country metadata
  filter(!is.na(income)) %>%
  select(iso3c, country, date, SCI  ) %>%
  group_by(date) %>%
  arrange(-SCI) %>%
  mutate(SCI_rank=rank(-SCI),
         SCI_rank=if_else(is.na(SCI),as.numeric(NA),SCI_rank))


#check unique values by dimension.
unique_scores_df <- sci_df %>% filter(date==2020) %>% mutate(SCI=round(SCI,3))
unique_scores_sci <-length(unique(unique_scores_df$SCI))



#read in ODIN data
  for (i in c(2015,2016,2017,2018,2020,2021,2022)) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i) %>%
        filter(Data.categories=='All Categories') %>%
        #convert all columns in "Indicator.coverage.and.disaggregation" "Data.available.last.5.years"           "Data.available.last.10.years"          "First.administrative.level"     "Second.administrative.level"           "Coverage.subscore"                     "Machine.readable"                      "Non.proprietary"                       "Download.options"                      "Metadata.available"                    "Terms.of.use"                          "Openness.subscore"                     "Overall.score"  to numeric
        mutate(
          across(
            c('Indicator.coverage.and.disaggregation', 'Data.available.last.5.years', 'Data.available.last.10.years', 'First.administrative.level', 'Second.administrative.level', 'Coverage.subscore', 'Machine.readable', 'Non.proprietary', 'Download.options', 'Metadata.available', 'Terms.of.use', 'Openness.subscore', 'Overall.score'),
            as.numeric
          )
          ) %>%     
        select(-Year)


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018, odin_df_2020, odin_df_2021, odin_df_2022)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) %>% 
  right_join(spi_df_empty) %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("ODIN"), na.locf, na.rm=FALSE)) %>%
  select(country, date, starts_with("ODIN"))


#read in the old SPI
# SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
#   transmute(
#     iso3c=Country,
#     SPI_2016=as.numeric(Overall...7),
#     SPI_2017=as.numeric(Overall...12),
#     SPI_2018=as.numeric(Overall...17)
#   ) %>%
#   pivot_longer(
#     cols=c('SPI_2016','SPI_2017','SPI_2018'),
#     names_to="date",
#     values_to = 'SPI_v0'
#   ) %>%
#   mutate(date=gsub('SPI_','',date),
#          date=as.numeric(date))


#create one database
comparison_df <- spi_index_df %>%
  ungroup() %>%
  filter(date %in% c(2016:end_date)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~1*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  #left_join(SPI_v0_df) %>%
  group_by(iso3c) %>%
  fill(SCI, .direction='downup')




```

*Figure 7.5: Distribution of SPI overall score across Countries*
```{r density}

density_df <- comparison_df %>%
  select(iso3c, date, SPI.INDEX, ODIN_score, SCI) %>%
  pivot_longer(
    cols = c('SPI.INDEX', 'ODIN_score', 'SCI'),
    names_to='index',
    values_to='index_values'
  ) %>%
  mutate(
    index_name=case_when(
      index=='SPI.INDEX' ~ "SPI overall score",
      index=='ODIN_score' ~ "Open Data Watch",
      index=='SCI' ~ "SCI",
      
    )
  )

#show the density of our SPI index
ggplot(spi_index_df, aes(x = SPI.INDEX)) + 
  facet_wrap(~date) +
  geom_histogram( 
                          aes(y=..density.., fill=..count..)) +
  stat_function(fun = dnorm, 
                color='red',
                args = list(mean = mean(spi_index_df$SPI.INDEX, na.rm=T), sd = sd(spi_index_df$SPI.INDEX, na.rm=T))) +
    theme_spi() +
  labs(
    title='Distribution of SPI overall score across Countries',
    color='Index Name'
  ) +
  xlab('SPI overall score') +
  theme(legend.position = 'bottom')



```


```{r density2, eval=FALSE, include=FALSE}
#show the density of our SPI index compared to other indices
ggplot(density_df, aes(x = index_values, color=index_name)) + 
  facet_wrap(~date) +
  geom_density() +
    theme_spi() +
  labs(
    title='Distribution of SPI overall score and alternative indices across countries',
    color='Index Name'
  ) +
  xlab('Index value') +
  theme(legend.position = 'bottom')
```

# Further Project Information


## Process for Inquiring about and Validating the Data

The data for the Statistical Performance Indicators are collected from established public and open sources. The team makes every effort to ensure that the data presented in the Statistical Performance Indicators are accurate, but it is possible that the sources used to assign values for the indicators are occasionally not up to date or accurate despite these efforts. Countries and all other users have the opportunity to inquire about the values that make up the indicators through contacting the Bank directly or via data@worldbank.org.

## Process for Updating Indicators

While the framework put forth in this note is designed to capture the contours of statistical systems around the world over the next decade and beyond, the indicators themselves are expected to improve over time. Changing indicators over time does come with a tradeoff: while it would improve the measurement of statistical performance, it would break the comparability with previous measures. Recognizing this trade-off, we plan to follow a 2- to 3-year cycle when, new indicators may be introduced and current indicators re-evaluated based on feedback from stakeholders and users, including national authorities. Whenever such a change takes place, the historical SPI series would need to be updated for comparability over time.  In order to be completely transparent, all changes to methodology will be tracked through a publicly available [github repository](https://github.com/worldbank/SPI) and all code and underlying data to produce the indicators will be published.



## Links to Resources

The following resources are available to learn more about the project.

  1.    The [SPI Project Website](https://www.worldbank.org/spi) provides an overview of the project, allows users to quickly explore some of the SPI data, and offers a link to the World Development Report 2021: Data for Better Lives, the SPI World Bank policy research working paper, and a list of frequently asked questions.
  
  2.    The [SPI Github repository](https://github.com/worldbank/SPI) contains the raw data used to produce our indicators, code to reproduce the values for all of our indicators and overall scores written in R, which is an open source statistical language, and a final data set available in CSV and Stata format.  A detailed Readme file is available detailing how to use the code.  The repository is licensed under the Creative Commons Attribution 4.0 International License, which means users are free to share or adapt any of the materials available, so long as appropriate credit is given to the SPI team.  The github repository also contains the version control history, which documents every change in the data and code of the entire project dating back to July 2020 to build confidence and transparency.
  
  3.    The [SPI Interactive Dashboard](https://datanalytics.worldbank.org/SPI) is available for a more detailed exploration of the data.  In this application, it is possible to map any of the 51 Statistical Performance Indicators, to explore a country report for each of the 174 countries, and use a tool to see how the SPI overall scores change when alternative weights are applied to the dimensions and pillars.


# Conclusion

The new Statistical Performance Indicators (SPI) will replace the Statistical Capacity Index (SCI), which the World Bank has regularly published since 2004. Although the goals are the same, to offer a better tool to measure the statistical systems of countries, the new SPI framework has expanded into new areas including in the areas of data use, administrative data, geospatial data, data services, and data infrastructure. The SPI provides a framework that can help countries measure where they stand in several dimensions and offers an ambitious measurement agenda for the international community.

The goal of the SPI is to offer a framework that is forward looking, measures less mature statistical systems as well as advanced systems, covers the broader national statistical system beyond the National Statistical Office (NSO), and gives countries incentives to build a modern statistical system. The project uses open data and open code to build confidence in the work. The data will also be updated on a yearly basis to track progress over time.

More research and data collection is, however, needed to improve measurement. Several of the dimensions of the SPI do not have measurable indicators yet.  One of the functions of the dashboard is to motivate action on the part of the international community to help improve the collection of data so we can better measure these areas.

Countries and international organizations need to know the current capabilities of national statistical systems, and the new SPI is meant to provide insights into this. Through the SPI, there is the potential for countries and donors to create mechanisms for learning from their peers to develop a virtuous cycle of investment, effectiveness, innovation, value added, and impact.




# Appendix

## Country SPI overall scores

Below, the full list of countries by their SPI overall score in 2020 is presented. The first column is the country name and the following columns are the overall SPI overall score, and then the sub-scores for pillars 1,2,3,4 and 5.

The purpose of the SPI is to help countries assess and improve the performance of their statistical systems. The presentation of SPI overall scores is designed to reflect that aim. Small differences between countries should not be highlighted since they are likely to reflect imprecision arising from the methodology rather than meaningful differences in performance. Instead, presentation of overall SPI scores focuses on larger groupings of countries reflecting broad categories of performance as measured by the indicator framework.

Countries shaded in dark orange are the lowest performing, countries in dark green are the highest performing. Countries are grouped into five groups:
 

* **Top Quintile**:  Countries in the Top quintile are classified in this group.  Shading in <span style="color:#2ec4b6">dark green</span>.    
* **4th Quintile**: Countries in the 4th quintile, or those above the 60th percentile but below the 80th percentile are in this group.  Shading in <span style="color:#acece7">light green</span>.    
* **3rd Quintile**: Countries in the 3rd quintile, or those between the 40th and 60th percentile, are classified in this group.  Shading in <span style="color:#f1dc76">yellow</span>.  
* **2nd Quintile**: Countries in the 2nd quintile, or those above the 20th percentile but below the 40th percentile, are in this group.  Shading in <span style="color:#ffbf69">light orange</span>.  
* **Bottom 20%**: Countries in the bottom 20% are classified in this group.  Shading in <span style="color:#ff9f1c">dark orange </span>.  



*Table A.1: SPI overall score in `r end_date` and Pillar Scores*
```{r tab1, echo=FALSE}


#colors

col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab <- index_disp %>%
  filter(date==end_date) %>%
  select(country, SPI.INDEX,SPI.INDEX.PIL1,SPI.INDEX.PIL2,SPI.INDEX.PIL3,SPI.INDEX.PIL4,SPI.INDEX.PIL5) 

 #calculate the breaks for the color coding
        brks <- quantile(index_tab$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)

        brks1 <- quantile(index_tab$SPI.INDEX.PIL1, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab$SPI.INDEX.PIL2, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab$SPI.INDEX.PIL3, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab$SPI.INDEX.PIL4, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        
        brks5 <- quantile(index_tab$SPI.INDEX.PIL5, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        

      #make nice looking
      index_tab <- index_tab %>%
        flextable() %>%
        # add_header_lines('SPI overall score in end_date and Pillar Scores.') %>%
        set_header_labels(values=list(
                             country="Country",
                             SPI.INDEX="SPI overall score",
                             SPI.INDEX.PIL1="Pillar 1: Data Use",
                             SPI.INDEX.PIL2="Pillar 2: Data Services",
                             SPI.INDEX.PIL3="Pillar 3: Data Products ",
                             SPI.INDEX.PIL4="Pillar 4: Data Sources",
                             SPI.INDEX.PIL5="Pillar 5: Data Infrastructure"
                                         )) %>%
          bg(j = c('SPI.INDEX'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL1'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL2'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL3'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL4'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL5'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))
# 
# #make nice looking
# index_tab <- index_tab %>%
#   flextable() %>%
#   add_header_lines('SPI overall score in end_date and pillar Scores.') %>%
#   set_header_labels(values=list(
#                        country="Country", 
#                        SPI.INDEX="SPI overall score",
#                        SPI.INDEX.PIL1="Dim 1: Data Use",
#                        SPI.INDEX.PIL2="Dim 2: Data Services",
#                        SPI.INDEX.PIL3="Dim 3: Data Products ",
#                        SPI.INDEX.PIL4="Dim 4: Data Sources",
#                        SPI.INDEX.PIL5="Dim 5: Data Infrastructure"
#                                    )) %>%
#     bg(j = c('SPI.INDEX'), 
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL1'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL2'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL3'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL4'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL5'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE))
# 
#   

FitFlextableToPage(index_tab)

```
## Country SPI overall scores over time

*Table A.2: SPI overall scores over time*
```{r tabtime, echo=FALSE}


#colors
col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab_time <- spi_index_df %>%
  select(iso3c, date, SPI.INDEX) %>%
  mutate(SPI.INDEX=round(SPI.INDEX,1)) %>%
  filter(!is.na(SPI.INDEX)) %>%
  pivot_wider(
    names_from=date,
    values_from=SPI.INDEX,
    names_prefix='SPI.INDEX.'
  ) %>%
  left_join(country_metadata) %>%
  select(country, starts_with('SPI.INDEX'))


#quintile groups
        brks <- quantile(index_tab_time$SPI.INDEX.2021, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)
        brks1 <- quantile(index_tab_time$SPI.INDEX.2020, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab_time$SPI.INDEX.2019, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab_time$SPI.INDEX.2018, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab_time$SPI.INDEX.2017, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        brks5 <- quantile(index_tab_time$SPI.INDEX.2016, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        brks6 <- quantile(index_tab_time$SPI.INDEX.2022, probs=c(1,2,3,4)/5,na.rm=T)
        brks6 <- append(0,brks6)
        if (max(brks6)<100) brks6 <- append(brks6,100)

#make nice looking
index_tab_time <- index_tab_time %>%
  flextable() %>%
  add_header_lines('SPI overall scores over time') %>%
  set_header_labels(values=list(
                       country="Country", 
                       SPI.INDEX.2022="2022",
                       SPI.INDEX.2021="2021",
                       SPI.INDEX.2020="2020",
                       SPI.INDEX.2019="2019",
                       SPI.INDEX.2018="2018",
                       SPI.INDEX.2017="2017",
                       SPI.INDEX.2016="2016"
                                   )) %>%
    bg(j = c('SPI.INDEX.2022'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks6, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2021'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2020'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2019'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2018'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2017'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2016'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))

  

FitFlextableToPage(index_tab_time)

```




```{r tabrecode, eval=FALSE, include=FALSE}


#colors
col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab_recode <- index_compare %>%
  mutate(SPI.INDEX=round(SPI.INDEX,1),
         SPI.INDEX.ALT=round(SPI.INDEX.ALT,1),
         SPI.INDEX.ALT2=round(SPI.INDEX.ALT2,1)) %>%
  select(country, SPI.INDEX, spi_groups, SPI.INDEX.ALT, spi_alt_groups, SPI.INDEX.ALT2, spi_alt2_groups)
#make nice looking
index_tab_recode <- index_tab_recode %>%
  flextable() %>%
  add_header_lines('SPI overall scores over time') %>%
  set_header_labels(values=list(
                       country="Country", 
                       SPI.INDEX="SPI Overall Score",
                       spi_groups="SPI Maturity Grouping",
                       SPI.INDEX.ALT="SPI Overall Score: Top Coding OECD High Income Countries for pillar 3.",
                       spi_alt_groups="SPI Maturity Grouping: Top Coding OECD High Income",
                       SPI.INDEX.ALT2="SPI Overall Score: Top Coding All High Income Countries for pillar 3.",
                       spi_alt2_groups="SPI Maturity Grouping: Top Coding All High Income"
                                   )) %>%
    bg(j = c('SPI.INDEX'), 
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
    bg(j = c('spi_groups'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE), source = 'SPI.INDEX') %>%
    bg(j = c('SPI.INDEX.ALT'), 
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
    bg(j = c('spi_alt_groups'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE), source = 'SPI.INDEX.ALT') %>%
    bg(j = c('SPI.INDEX.ALT2'), 
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
    bg(j = c('spi_alt2_groups'),
       bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE), source = 'SPI.INDEX.ALT2')   

FitFlextableToPage(index_tab_recode)

```

##  SPI Overall and Pillar Scores by Region, Income, & Lending
*Table A.3: Table of SPI Overall and Pillar Scores by Region in `r end_date`*
```{r maturitytabreg, fig.cap=''}

indicators<-c("SPI.INDEX","SPI.INDEX.PIL1","SPI.INDEX.PIL2","SPI.INDEX.PIL3",
              "SPI.INDEX.PIL4","SPI.INDEX.PIL5")

spi_group_table('spi_index_df',indicators,2021, 'region') %>%
  flextable() %>%
  # add_header_lines('') %>%
  FitFlextableToPage() %>%
  align( align = "left", part = "body")


```


*Table A.4: Table of SPI Overall and Pillar Scores by Income Group in `r end_date`*
```{r maturitytabinc, fig.cap=''}

indicators<-c("SPI.INDEX","SPI.INDEX.PIL1","SPI.INDEX.PIL2","SPI.INDEX.PIL3",
              "SPI.INDEX.PIL4","SPI.INDEX.PIL5")

spi_group_table('spi_index_df',indicators,end_date, 'income') %>%
  flextable() %>%
  # add_header_lines('') %>%
  FitFlextableToPage() %>%
  align( align = "left", part = "body")


```

*Table A.5: Table of SPI Overall and Pillar Scores by Lending Group in `r end_date`*
```{r maturitytablend, fig.cap=''}

indicators<-c("SPI.INDEX","SPI.INDEX.PIL1","SPI.INDEX.PIL2","SPI.INDEX.PIL3",
              "SPI.INDEX.PIL4","SPI.INDEX.PIL5")

spi_group_table('spi_index_df',indicators,end_date, 'lending_type') %>%
  flextable() %>%
  # add_header_lines('') %>%
  FitFlextableToPage() %>%
  align( align = "left", part = "body")


```

*Figure A.1: SPI Pillar 1 - Data Use Score - By Region in `r end_date`*
```{r spiregcharts1}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX.PIL1','SPI Data Use Score')

```

*Figure A.2: SPI Pillar 2 - Data Services Score - By Region in `r end_date`*
```{r spiregcharts2}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX.PIL2','SPI Data Services Score')

```

*Figure A.3: SPI Pillar 3 - Data Products Score - By Region in `r end_date`*
```{r spiregcharts3}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX.PIL3','SPI Data Products Score')

```

*Figure A.4: SPI Pillar 4 - Data Sources Score - By Region in `r end_date`*
```{r spiregcharts4}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX.PIL4','SPI Data Sources Score')

```

*Figure A.5: SPI Pillar 5 - Data Infrastructure Score - By Region in `r end_date`*
```{r spiregcharts5}
#show map and summary stats by region and income group

spi_region_charts('spi_index_df','SPI.INDEX.PIL5','SPI Data Infrastructure Score')

```

## Comparison to other measures of statistical performance

Next, the SPI is compared with several other indices of statistical performance that have been created. This provides a sense of how rankings differ across measures, how they correlate with other outcomes, and how the distributions of scores compare. These are the SCI, the Open Data Watch index (ODIN), and version 0 of the SPI overall score that was produced in [@cameron2019measuring] 

We first compare the SPI overall score to the older World Bank [Statistical Capacity Index](http://datatopics.worldbank.org/statisticalcapacity/SCIdashboard.aspx).  The correlation between the SPI overall score and the SCI  is `r round(cor(comparison_df$SPI.INDEX,comparison_df$SCI, use='pairwise.complete.obs'),3)`.

*Figure A.6: Scatterplot of Statistical Capacity Index (SCI) and SPI Overall Score *
```{r sci}

### Scatterplot SCI SPI
spi_sci_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=SCI, color=region)) +
  facet_wrap(~date) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_spi() +
  labs(
    title='Scatterplot of Statistical Capacity Index (SCI) and SPI Overall Score'
  ) +
  ylab('SPI Overall Score') +
  xlab('SCI value') +
  theme(legend.position = 'bottom')

spi_sci_plot


```


```{r scispireg}
gdp_reg_df <- wbstats::wb_data(
  indicator='NY.GDP.PCAP.KD',
  start_date=2016,
  end_date=2021
    ) %>%
  mutate(log_gdp_pcap=log(NY.GDP.PCAP.KD)) %>%
  left_join(select(comparison_df,iso3c,date, region,SPI.INDEX,SCI,ODIN_score)) #merge on SPI Index data
  
  
#regress Log GDP SPI
m_spi <- lm_robust(SPI.INDEX ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 

m_spi_lm <- lm(SPI.INDEX ~ log_gdp_pcap + factor(date), data = filter(gdp_reg_df,!(is.na(SPI.INDEX) | is.na(log_gdp_pcap)))) 
gdp_reg_df_resids <- broom::augment(m_spi_lm, data=filter(gdp_reg_df,!(is.na(SPI.INDEX) | is.na(log_gdp_pcap)) ))


#regress Log GDP SCI
m_sci <- lm_robust(SCI ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 


#regress Log GDP ODIN
m_odin <- lm_robust(ODIN_score ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 


#regress Log GDP SPI_v0
# m_spi_v0 <- lm_robust(SPI_v0 ~ log_gdp_pcap + factor(date), data = gdp_reg_df, se_type = "HC2") 
# 
m_spi_tidy <- broom::tidy(m_spi)
m_spi_glance <- broom::glance(m_spi)
# 
spi_coef <- as.numeric(m_spi_tidy[2,2])
spi_r2 <- as.numeric(m_spi_glance[1,1])

```




Next, the relationship is shown between Log GDP per capita, the SCI and the SPI overall score using linear regression. The Open Data Watch ODIN score and the version of the Statistical Performance Index developed in [@cameron2019measuring] are also included. While showing a strong relationship between an index and log GDP per capita does not mean the index is necessarily correct, and is certainly not necessarily causal, it does provide a face validity check of the index. Heteroskedasticity robust standard errors are shown in the table.

Overall, the new SPI overall score has the strongest relationship to GDP per capita.  The linear regression estimates indicate that a 1% increase in GDP per capita is associated with a `r round(spi_coef/100,1)` point increase in the SPI overall score.  The r-squared from this regression is `r round(spi_r2,2)`.


*Table A.6: Relationship between Statical Performance Measures and GDP per capita.*
```{r scispiregtab}



#combine SPI and SCI results together
date_names <- grep("factor", names(coef(m_spi)), value = TRUE)
names(date_names) <- gsub(".*)(.)", "Year: \\1", date_names)

huxtable::huxreg('SPI overall score'=m_spi, 'SCI'=m_sci, 'Open Data Watch'=m_odin, 
       coefs=c('Log GDP per Capita'='log_gdp_pcap', date_names, 'Intercept'='(Intercept)'),
       note='{stars}. Heteroskedasticity Robust Std Errors in Parenthesis',
       number_format=2,
       bold_signif=0.05) %>%
  # huxtable::set_caption('Linear Regressions of Alternate Statistical Performance Indices on Log GDP per Capita') %>%
  huxtable::as_flextable() %>%
  FitFlextableToPage() %>%
  width(width=1.2)



gdp_long <- gdp_reg_df %>%
  pivot_longer(
    cols = c('SPI.INDEX', 'ODIN_score', 'SCI'),
    names_to='index',
    values_to='index_values'
  ) %>%
  mutate(
    index_name=case_when(
      index=='SPI.INDEX' ~ "SPI overall score",
      index=='ODIN_score' ~ "Open Data Watch",
      index=='SCI' ~ "SCI",
      
    )
  ) %>%
  filter(date==2021)

ggplot(gdp_long, aes(x=log_gdp_pcap,y=index_values, color=region)) +
  facet_wrap(~index_name) +
  # geom_point() +
  geom_text(aes(label=iso3c)) +
  theme_spi() +
  labs(
    title='Scatterplot of Alternate Statistical Performance Indices on Log GDP per Capita'
  ) +
  xlab('Log GDP Per Capita') +
  ylab('Index Values') +
  theme(legend.position = 'bottom')

```



We compare the SPI overall score to the [Open Data Watch rankings of country statistical systems](https://odin.opendatawatch.com/report/rankings).  The correlation between the SPI overall score and the ODIN index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$ODIN_score, use='pairwise.complete.obs'),3)`
 


```{r odin, echo=FALSE}

 

### Scatterplot ODIN SPI
spi_odin_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=ODIN_score, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  theme_spi() +
  labs(
    title='Scatterplot of SPI overall score on Open Data Watch Index'
  ) +
  ylab('SPI overall score') +
  xlab('ODIN value') +
  theme(legend.position = 'bottom')

spi_odin_plot




```





## Other Tables and Figures

*Table A.7: Linear Regressions of Government Effectiveness Score on SPI Overall Score from 2016-19*
```{r gereg, echo=FALSE}
# 





ge_spi <- lm_robust(GE.EST ~ SPI.INDEX + log(NY.GDP.PCAP.KD) + factor(date) + factor(region) , data = ge_df, se_type = "HC2") 

ge_spi_tidy <- broom::tidy(ge_spi)
ge_spi_glance <- broom::glance(ge_spi)

#fix labels
factor_names <- grep("factor", names(coef(ge_spi)), value = TRUE)
names(factor_names) <- gsub(".*)(.)", "\\1", factor_names)


#create table
huxtable::huxreg('Goverment Effectiveness'=ge_spi,
       coefs=c('SPI Overall Score'='SPI.INDEX', 'Log GDP per Capita'='log(NY.GDP.PCAP.KD)', factor_names,  'Intercept'='(Intercept)'),
       note='{stars}. Heteroskedasticity Robust Std Errors in Parenthesis.',
       number_format=3,
       bold_signif=0.05) %>%
  #huxtable::set_caption('Linear Regressions of Changes in Government Effectiveness on Changes in SPI from 2016-19') %>%
  huxtable::as_flextable() %>%
  # add_header_lines('Linear Regressions of Government Effectiveness Score on SPI Overall Score from 2016-19') %>%
  FitFlextableToPage() 

```

## Indicator Metadata

*Table A.8: SPI Indicator Metadata*
```{r metadatatab2}
####
# create table
####

metatable <- metadata %>%
  filter(grepl('SPI.D',source_id)) %>%
  select(-spi_indicator_name,-source_id)



index_tab <- flextable(metatable) %>%
  # add_header_lines('SPI Indicator Metadata.') %>%
  set_header_labels(values=list(
                       source_name="Indicator Name",
                       SPI_indicator_id="Dimension",
                       spi_indicator_description="Brief Description",
                       spi_indicator_scoring="Scoring"
                                   ))
  FitFlextableToPage(index_tab) %>%
  width(width=1.63)


```


```{r polar_coordinates, eval=FALSE, fig.height=20, fig.width=20, include=FALSE}

  variables<-'SPI.INDEX'

  title <- metadata_full %>%
    filter(source_id==variables)
  
  title <- title$source_name
    
  SPI_changes <- spi_index_df %>%
    rename(outcome=!!variables) %>%
    select(country,iso3c, date, iso3c,region, outcome) %>%
    filter(!is.na(outcome)) %>%
    pivot_wider(
      names_from='date',
      names_prefix='outcome_',
      values_from='outcome'
      ) %>%
    mutate(change=outcome_2020-outcome_2016,
           color=if_else(change>=0,'improved', 'decreased')) %>%
    arrange(-outcome_2020) %>%
    mutate(country=factor(country, levels=unique(spi_index_df$country)))
  
  p<- ggplot(SPI_changes, aes(x=country)) +
    geom_point(aes(y=outcome_2016)) +
    geom_point(aes(y=outcome_2020), color='blue') +
    geom_segment( aes(x=country ,xend=country, y=outcome_2016, yend=outcome_2020,
                      color=color)) +
    scale_color_manual(values = c('decreased' = "red", 'improved' = "green")) +
    coord_polar() +
    theme_spi() +
    labs(
      title=paste(title, "Change from 2016-2020", sep=" - "),
      subtitle='Source: Statistical Performance Indicators',
      color = 'Change 2016-2020') +
    ylab('SPI Value')
    
  p


```


# References

